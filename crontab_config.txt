# ============================================================================
# CONFIGURA√á√ÉO DO CRON JOB - CONFIRMA√á√ÉO AUTOM√ÅTICA DE ORDENS
# ============================================================================
#
# Este arquivo cont√©m instru√ß√µes para configurar o job autom√°tico que
# confirma ordens de servi√ßo ap√≥s 36 horas sem resposta do cliente.
#
# ============================================================================

## VIS√ÉO GERAL

O sistema possui um job autom√°tico (jobs/auto_confirm_orders.py) que deve
ser executado periodicamente para processar ordens que ultrapassaram o prazo
de 36 horas sem confirma√ß√£o manual do cliente.

Quando uma ordem atinge esse prazo, o sistema:
- Confirma automaticamente a ordem
- Processa os pagamentos (transfere valores para prestador e admin)
- Devolve as taxas de contesta√ß√£o
- Notifica ambas as partes
- Registra que a confirma√ß√£o foi autom√°tica


## PR√â-REQUISITOS

1. Python 3.11 instalado no sistema
2. Ambiente virtual configurado (se aplic√°vel)
3. Permiss√µes de escrita no diret√≥rio de logs
4. Acesso ao crontab do usu√°rio


## LINHA DO CRON JOB

Adicione a seguinte linha ao crontab para executar o job a cada hora:

0 * * * * cd /home/w-jr/Documentos/Combinado_Manus && /usr/bin/python3.11 jobs/auto_confirm_orders.py >> logs/cron_auto_confirm.log 2>&1

### Explica√ß√£o da linha:

- `0 * * * *` : Executa no minuto 0 de cada hora (00:00, 01:00, 02:00, etc.)
- `cd /home/w-jr/Documentos/Combinado_Manus` : Navega para o diret√≥rio do projeto
- `&&` : Executa o pr√≥ximo comando apenas se o anterior for bem-sucedido
- `/usr/bin/python3.11` : Caminho completo do Python 3.11
- `jobs/auto_confirm_orders.py` : Script do job
- `>>` : Redireciona a sa√≠da (append)
- `logs/cron_auto_confirm.log` : Arquivo de log do cron
- `2>&1` : Redireciona erros (stderr) para o mesmo arquivo de log


## VARIA√á√ïES DE FREQU√äNCIA

Se desejar executar em intervalos diferentes, ajuste os primeiros campos:

# A cada 30 minutos:
*/30 * * * * cd /home/w-jr/Documentos/Combinado_Manus && /usr/bin/python3.11 jobs/auto_confirm_orders.py >> logs/cron_auto_confirm.log 2>&1

# A cada 2 horas:
0 */2 * * * cd /home/w-jr/Documentos/Combinado_Manus && /usr/bin/python3.11 jobs/auto_confirm_orders.py >> logs/cron_auto_confirm.log 2>&1

# A cada 6 horas:
0 */6 * * * cd /home/w-jr/Documentos/Combinado_Manus && /usr/bin/python3.11 jobs/auto_confirm_orders.py >> logs/cron_auto_confirm.log 2>&1

# Diariamente √†s 3h da manh√£:
0 3 * * * cd /home/w-jr/Documentos/Combinado_Manus && /usr/bin/python3.11 jobs/auto_confirm_orders.py >> logs/cron_auto_confirm.log 2>&1


## INSTRU√á√ïES DE INSTALA√á√ÉO

### 1. Verificar o caminho do Python 3.11

Antes de configurar, confirme o caminho do Python:

```bash
which python3.11
```

Se o caminho for diferente de `/usr/bin/python3.11`, ajuste a linha do cron.


### 2. Verificar o caminho do projeto

Confirme o caminho completo do diret√≥rio do projeto:

```bash
pwd
```

Atualize o caminho na linha do cron se necess√°rio.


### 3. Criar diret√≥rio de logs (se n√£o existir)

```bash
mkdir -p logs
chmod 755 logs
```


### 4. Testar o job manualmente

Antes de adicionar ao cron, teste a execu√ß√£o manual:

```bash
cd /home/w-jr/Documentos/Combinado_Manus
python3.11 jobs/auto_confirm_orders.py
```

Verifique se n√£o h√° erros e se o log foi criado em `logs/auto_confirm_orders.log`.


### 5. Editar o crontab

Abra o editor do crontab:

```bash
crontab -e
```

Se for a primeira vez, o sistema pode perguntar qual editor usar.
Recomendamos `nano` para iniciantes ou `vim` para usu√°rios avan√ßados.


### 6. Adicionar a linha do cron

No editor, adicione a linha do cron job ao final do arquivo:

```
0 * * * * cd /home/w-jr/Documentos/Combinado_Manus && /usr/bin/python3.11 jobs/auto_confirm_orders.py >> logs/cron_auto_confirm.log 2>&1
```

Salve e feche o editor:
- No nano: Ctrl+O (salvar), Enter, Ctrl+X (sair)
- No vim: Esc, :wq, Enter


### 7. Verificar a instala√ß√£o

Liste os cron jobs ativos para confirmar:

```bash
crontab -l
```

Voc√™ deve ver a linha que acabou de adicionar.


### 8. Verificar execu√ß√£o

Ap√≥s a primeira hora, verifique se o job foi executado:

```bash
# Ver log do cron
cat logs/cron_auto_confirm.log

# Ver log detalhado do job
tail -f logs/auto_confirm_orders.log
```


## MONITORAMENTO E MANUTEN√á√ÉO

### Verificar logs regularmente

```bash
# Ver √∫ltimas 50 linhas do log do job
tail -50 logs/auto_confirm_orders.log

# Monitorar em tempo real
tail -f logs/auto_confirm_orders.log

# Ver log do cron
tail -50 logs/cron_auto_confirm.log
```


### Verificar se o cron est√° rodando

```bash
# Ver processos do cron
ps aux | grep cron

# Ver logs do sistema (Ubuntu/Debian)
grep CRON /var/log/syslog | tail -20
```


### Rota√ß√£o de logs

Para evitar que os logs cres√ßam indefinidamente, configure a rota√ß√£o:

Crie o arquivo `/etc/logrotate.d/auto_confirm_orders`:

```
/home/w-jr/Documentos/Combinado_Manus/logs/auto_confirm_orders.log {
    daily
    rotate 30
    compress
    delaycompress
    missingok
    notifempty
}

/home/w-jr/Documentos/Combinado_Manus/logs/cron_auto_confirm.log {
    daily
    rotate 30
    compress
    delaycompress
    missingok
    notifempty
}
```


## COMANDOS √öTEIS

### Listar cron jobs ativos
```bash
crontab -l
```

### Editar cron jobs
```bash
crontab -e
```

### Remover todos os cron jobs (CUIDADO!)
```bash
crontab -r
```

### Desabilitar temporariamente o job
Comente a linha no crontab adicionando `#` no in√≠cio:
```bash
crontab -e
# Adicione # antes da linha:
# 0 * * * * cd /home/w-jr/Documentos/Combinado_Manus && ...
```

### Executar manualmente para teste
```bash
cd /home/w-jr/Documentos/Combinado_Manus
python3.11 jobs/auto_confirm_orders.py
```


## TROUBLESHOOTING

### Problema: Job n√£o est√° executando

1. Verifique se o cron est√° rodando:
   ```bash
   sudo service cron status
   ```

2. Verifique os logs do sistema:
   ```bash
   grep CRON /var/log/syslog | tail -20
   ```

3. Verifique permiss√µes do arquivo:
   ```bash
   ls -la jobs/auto_confirm_orders.py
   chmod +x jobs/auto_confirm_orders.py
   ```


### Problema: Erros de importa√ß√£o

1. Verifique se est√° usando o Python correto:
   ```bash
   /usr/bin/python3.11 --version
   ```

2. Verifique se as depend√™ncias est√£o instaladas:
   ```bash
   /usr/bin/python3.11 -m pip list
   ```

3. Se usar ambiente virtual, ative-o no cron:
   ```
   0 * * * * cd /home/w-jr/Documentos/Combinado_Manus && source .venv/bin/activate && python jobs/auto_confirm_orders.py >> logs/cron_auto_confirm.log 2>&1
   ```


### Problema: Permiss√µes negadas

1. Verifique permiss√µes do diret√≥rio de logs:
   ```bash
   ls -la logs/
   chmod 755 logs/
   ```

2. Verifique se o usu√°rio do cron tem acesso ao projeto:
   ```bash
   whoami
   ls -la /home/w-jr/Documentos/Combinado_Manus
   ```


### Problema: Job executa mas n√£o processa ordens

1. Verifique o log detalhado:
   ```bash
   tail -100 logs/auto_confirm_orders.log
   ```

2. Execute manualmente para ver erros:
   ```bash
   cd /home/w-jr/Documentos/Combinado_Manus
   python3.11 jobs/auto_confirm_orders.py
   ```

3. Verifique se h√° ordens eleg√≠veis:
   - Status deve ser "servico_executado"
   - confirmation_deadline deve ter passado


## VARI√ÅVEIS DE AMBIENTE

Se o projeto usa vari√°veis de ambiente, adicione-as ao cron:

```
0 * * * * cd /home/w-jr/Documentos/Combinado_Manus && export FLASK_ENV=production && /usr/bin/python3.11 jobs/auto_confirm_orders.py >> logs/cron_auto_confirm.log 2>&1
```

Ou carregue de um arquivo .env:

```
0 * * * * cd /home/w-jr/Documentos/Combinado_Manus && source .env && /usr/bin/python3.11 jobs/auto_confirm_orders.py >> logs/cron_auto_confirm.log 2>&1
```


## ALERTAS E NOTIFICA√á√ïES

Para receber emails quando o job falhar, adicione MAILTO no crontab:

```
MAILTO=seu-email@exemplo.com

0 * * * * cd /home/w-jr/Documentos/Combinado_Manus && /usr/bin/python3.11 jobs/auto_confirm_orders.py >> logs/cron_auto_confirm.log 2>&1
```

Nota: Requer configura√ß√£o de sendmail ou postfix no servidor.


## SEGURAN√áA

1. **Permiss√µes**: O arquivo do job n√£o precisa ser execut√°vel pelo cron,
   mas deve ter permiss√µes de leitura para o usu√°rio do cron.

2. **Logs sens√≠veis**: Os logs podem conter informa√ß√µes financeiras.
   Proteja o diret√≥rio de logs:
   ```bash
   chmod 700 logs/
   ```

3. **Backup**: Fa√ßa backup regular do crontab:
   ```bash
   crontab -l > crontab_backup_$(date +%Y%m%d).txt
   ```


## DESINSTALA√á√ÉO

Para remover o cron job:

1. Edite o crontab:
   ```bash
   crontab -e
   ```

2. Remova ou comente a linha do job

3. Salve e feche o editor

4. Verifique:
   ```bash
   crontab -l
   ```


## SUPORTE

Para mais informa√ß√µes sobre cron:
```bash
man cron
man crontab
man 5 crontab  # Formato do arquivo crontab
```

Documenta√ß√£o online:
- https://crontab.guru/ (gerador de express√µes cron)
- https://man7.org/linux/man-pages/man5/crontab.5.html


## HIST√ìRICO DE ALTERA√á√ïES

- 2025-01-XX: Cria√ß√£o inicial da documenta√ß√£o
- Configura√ß√£o para execu√ß√£o a cada hora
- Logs em logs/cron_auto_confirm.log


## NOTAS IMPORTANTES

‚ö†Ô∏è **ATEN√á√ÉO**: Este job processa transa√ß√µes financeiras. Certifique-se de:
- Testar completamente em ambiente de desenvolvimento
- Monitorar os logs regularmente
- Ter backups do banco de dados
- Configurar alertas para falhas

‚úÖ **RECOMENDA√á√ÉO**: Execute o job a cada hora para garantir que ordens
sejam confirmadas logo ap√≥s o prazo de 36 horas expirar.

üìä **M√âTRICAS**: Monitore as seguintes m√©tricas:
- N√∫mero de ordens confirmadas automaticamente por dia
- Taxa de sucesso do job
- Tempo m√©dio de execu√ß√£o
- Erros e exce√ß√µes

============================================================================
FIM DA DOCUMENTA√á√ÉO
============================================================================

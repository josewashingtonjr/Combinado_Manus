class PreOrdemRealtime{constructor(preOrderId,userId,userRole){this.preOrderId = preOrderId;this.userId = userId;this.userRole = userRole;this.eventSource = null;this.pollingInterval = null;this.lastUpdateTimestamp = null;this.isConnected = false;this.reconnectAttempts = 0;this.maxReconnectAttempts = 5;this.pollingIntervalMs = 30000;this.presenceCheckIntervalMs = 60000;this.presenceInterval = null;this.otherPartyPresent = false;this.onStatusChange = null;this.onProposalReceived = null;this.onProposalAccepted = null;this.onProposalRejected = null;this.onMutualAcceptance = null;this.onPresenceChange = null;this.onError = null;this.init();}init(){console.log(`[PreOrdemRealtime] Inicializando para pr√©-ordem ${this.preOrderId}`);if(this.supportsSSE()){this.connectSSE();}else{console.log('[PreOrdemRealtime] SSE n√£o suportado,usando polling');this.startPolling();}this.startPresenceCheck();this.registerPresence();this.setupPageListeners();this.createNotificationContainer();}supportsSSE(){return typeof EventSource !== 'undefined';}connectSSE(){try{const url = `/pre-ordem/${this.preOrderId}/stream?user_id=${this.userId}&role=${this.userRole}`;this.eventSource = new EventSource(url);this.eventSource.onopen =()=>{console.log('[PreOrdemRealtime] Conex√£o SSE estabelecida');this.isConnected = true;this.reconnectAttempts = 0;this.stopPolling();this.showConnectionStatus(true);};this.eventSource.onmessage =(event)=>{this.handleSSEMessage(event);};this.eventSource.addEventListener('status_change',(event)=>{this.handleStatusChange(JSON.parse(event.data));});this.eventSource.addEventListener('proposal_received',(event)=>{this.handleProposalReceived(JSON.parse(event.data));});this.eventSource.addEventListener('proposal_accepted',(event)=>{this.handleProposalAccepted(JSON.parse(event.data));});this.eventSource.addEventListener('proposal_rejected',(event)=>{this.handleProposalRejected(JSON.parse(event.data));});this.eventSource.addEventListener('mutual_acceptance',(event)=>{this.handleMutualAcceptance(JSON.parse(event.data));});this.eventSource.addEventListener('presence',(event)=>{this.handlePresenceUpdate(JSON.parse(event.data));});this.eventSource.addEventListener('heartbeat',(event)=>{console.log('[PreOrdemRealtime] Heartbeat recebido');});this.eventSource.onerror =(error)=>{console.error('[PreOrdemRealtime] Erro SSE:',error);this.handleSSEError(error);};}catch(error){console.error('[PreOrdemRealtime] Erro ao conectar SSE:',error);this.startPolling();}}handleSSEMessage(event){try{const data = JSON.parse(event.data);console.log('[PreOrdemRealtime] Mensagem recebida:',data);if(data.type){switch(data.type){case 'status_change':this.handleStatusChange(data);break;case 'proposal_received':this.handleProposalReceived(data);break;case 'proposal_accepted':this.handleProposalAccepted(data);break;case 'proposal_rejected':this.handleProposalRejected(data);break;case 'mutual_acceptance':this.handleMutualAcceptance(data);break;case 'presence':this.handlePresenceUpdate(data);break;case 'connected':console.log('[PreOrdemRealtime] Conex√£o confirmada');break;}}this.lastUpdateTimestamp = new Date();}catch(error){console.error('[PreOrdemRealtime] Erro ao processar mensagem:',error);}}handleSSEError(error){this.isConnected = false;this.showConnectionStatus(false);if(this.eventSource){this.eventSource.close();this.eventSource = null;}this.reconnectAttempts++;if(this.reconnectAttempts < this.maxReconnectAttempts){const delay = Math.min(1000 * Math.pow(2,this.reconnectAttempts),30000);console.log(`[PreOrdemRealtime] Tentando reconectar em ${delay}ms...`);setTimeout(()=>{this.connectSSE();},delay);}else{console.log('[PreOrdemRealtime] M√°ximo de tentativas atingido,usando polling');this.startPolling();}}startPolling(){if(this.pollingInterval){return;}console.log(`[PreOrdemRealtime] Iniciando polling a cada ${this.pollingIntervalMs/1000}s`);this.pollForUpdates();this.pollingInterval = setInterval(()=>{this.pollForUpdates();},this.pollingIntervalMs);this.showPollingIndicator(true);}stopPolling(){if(this.pollingInterval){clearInterval(this.pollingInterval);this.pollingInterval = null;this.showPollingIndicator(false);}}async pollForUpdates(){try{const response = await fetch(`/pre-ordem/${this.preOrderId}/status`,{method:'GET',headers:{'Accept':'application/json','X-Requested-With':'XMLHttpRequest'}});if(!response.ok){throw new Error(`HTTP ${response.status}`);}const data = await response.json();if(data.success){this.processStatusUpdate(data);}this.lastUpdateTimestamp = new Date();}catch(error){console.error('[PreOrdemRealtime] Erro no polling:',error);if(this.onError){this.onError(error);}}}processStatusUpdate(data){const statusElement = document.querySelector('[data-pre-order-status]');const currentStatus = statusElement ? statusElement.dataset.preOrderStatus:null;if(currentStatus && currentStatus !== data.status){this.handleStatusChange({old_status:currentStatus,new_status:data.status,status_display:data.status_display});}if(data.has_mutual_acceptance){this.handleMutualAcceptance(data);}this.updateAcceptanceIndicators(data);if(data.has_active_proposal){this.updateProposalIndicator(true);}}startPresenceCheck(){this.presenceInterval = setInterval(()=>{this.checkPresence();},this.presenceCheckIntervalMs);}async registerPresence(){try{await fetch(`/pre-ordem/${this.preOrderId}/presenca`,{method:'POST',headers:{'Content-Type':'application/json','X-CSRFToken':this.getCSRFToken()},body:JSON.stringify({user_id:this.userId,action:'enter'})});}catch(error){console.error('[PreOrdemRealtime] Erro ao registrar presen√ßa:',error);}}async checkPresence(){try{const response = await fetch(`/pre-ordem/${this.preOrderId}/presenca?user_id=${this.userId}`,{method:'GET',headers:{'Accept':'application/json'}});if(response.ok){const data = await response.json();this.handlePresenceUpdate(data);}}catch(error){console.error('[PreOrdemRealtime] Erro ao verificar presen√ßa:',error);}}handleStatusChange(data){console.log('[PreOrdemRealtime] Status alterado:',data);this.updateStatusBadge(data.new_status,data.status_display);this.showToast(`Status atualizado para:${data.status_display}`,'info','fa-sync-alt');if(this.onStatusChange){this.onStatusChange(data);}if(['convertida','cancelada','expirada'].includes(data.new_status)){setTimeout(()=>{location.reload();},2000);}}handleProposalReceived(data){console.log('[PreOrdemRealtime] Nova proposta recebida:',data);this.showToast(`üìù Nova proposta recebida de ${data.proposer_name || 'outra parte'}!`,'warning','fa-file-alt');this.updateProposalIndicator(true);if(this.onProposalReceived){this.onProposalReceived(data);}setTimeout(()=>{location.reload();},1500);}handleProposalAccepted(data){console.log('[PreOrdemRealtime] Proposta aceita:',data);this.showToast('‚úÖ Sua proposta foi aceita! Os novos termos foram aplicados.','success','fa-check-circle');if(this.onProposalAccepted){this.onProposalAccepted(data);}setTimeout(()=>{location.reload();},1500);}handleProposalRejected(data){console.log('[PreOrdemRealtime] Proposta rejeitada:',data);this.showToast('‚ùå Sua proposta foi rejeitada. Voc√™ pode fazer uma nova proposta.','danger','fa-times-circle');if(this.onProposalRejected){this.onProposalRejected(data);}setTimeout(()=>{location.reload();},1500);}handleMutualAcceptance(data){console.log('[PreOrdemRealtime] Aceita√ß√£o m√∫tua alcan√ßada:',data);this.showToast('üéâ Ambas as partes aceitaram os termos! A pr√©-ordem ser√° convertida em ordem.','success','fa-handshake',10000);if(this.onMutualAcceptance){this.onMutualAcceptance(data);}setTimeout(()=>{location.reload();},3000);}handlePresenceUpdate(data){const wasPresent = this.otherPartyPresent;this.otherPartyPresent = data.other_party_present || false;this.updatePresenceIndicator(this.otherPartyPresent);if(wasPresent !== this.otherPartyPresent){if(this.otherPartyPresent){this.showToast(`üëÅÔ∏è ${data.other_party_name || 'A outra parte'}est√° visualizando esta pr√©-ordem`,'info','fa-eye',3000);}if(this.onPresenceChange){this.onPresenceChange(this.otherPartyPresent,data);}}}updateStatusBadge(status,statusDisplay){const badges = document.querySelectorAll('.status-badge-large,[data-pre-order-status]');badges.forEach(badge =>{badge.classList.remove('bg-primary','bg-secondary','bg-success','bg-danger','bg-warning','bg-info');const colorClass = this.getStatusColorClass(status);badge.classList.add(colorClass);badge.textContent = statusDisplay;badge.dataset.preOrderStatus = status;});badges.forEach(badge =>{badge.classList.add('status-updated');setTimeout(()=>{badge.classList.remove('status-updated');},1000);});}getStatusColorClass(status){const colorMap ={'em_negociacao':'bg-primary','aguardando_resposta':'bg-warning','pronto_conversao':'bg-info','convertida':'bg-success','cancelada':'bg-danger','expirada':'bg-secondary'};return colorMap[status] || 'bg-secondary';}updateAcceptanceIndicators(data){const clientBadge = document.querySelector('[data-acceptance="client"]');if(clientBadge){if(data.client_accepted_terms){clientBadge.className = 'badge bg-success';clientBadge.innerHTML = '<i class="fas fa-check"></i> Aceitou';}else{clientBadge.className = 'badge bg-warning';clientBadge.innerHTML = '<i class="fas fa-clock"></i> Pendente';}}const providerBadge = document.querySelector('[data-acceptance="provider"]');if(providerBadge){if(data.provider_accepted_terms){providerBadge.className = 'badge bg-success';providerBadge.innerHTML = '<i class="fas fa-check"></i> Aceitou';}else{providerBadge.className = 'badge bg-warning';providerBadge.innerHTML = '<i class="fas fa-clock"></i> Pendente';}}}updateProposalIndicator(hasProposal){const indicator = document.querySelector('.proposal-indicator,[data-proposal-indicator]');if(indicator){if(hasProposal){indicator.style.display = 'block';indicator.classList.add('pulse-animation');}else{indicator.style.display = 'none';indicator.classList.remove('pulse-animation');}}}updatePresenceIndicator(isPresent){let indicator = document.getElementById('presence-indicator');if(!indicator){indicator = document.createElement('div');indicator.id = 'presence-indicator';indicator.className = 'presence-indicator';document.body.appendChild(indicator);}if(isPresent){indicator.innerHTML = `
<i class="fas fa-eye me-2"></i>
<span>Outra parte visualizando</span>
`;indicator.classList.add('visible');}else{indicator.classList.remove('visible');}}showConnectionStatus(connected){let statusEl = document.getElementById('realtime-connection-status');if(!statusEl){statusEl = document.createElement('div');statusEl.id = 'realtime-connection-status';statusEl.className = 'realtime-status';document.body.appendChild(statusEl);}if(connected){statusEl.innerHTML = '<i class="fas fa-wifi me-1"></i> Tempo real';statusEl.className = 'realtime-status connected';}else{statusEl.innerHTML = '<i class="fas fa-exclamation-triangle me-1"></i> Reconectando...';statusEl.className = 'realtime-status disconnected';}}showPollingIndicator(active){let indicator = document.getElementById('polling-indicator');if(!indicator && active){indicator = document.createElement('div');indicator.id = 'polling-indicator';indicator.className = 'polling-indicator';indicator.innerHTML = `
<i class="fas fa-sync-alt me-1"></i>
<span>Atualiza√ß√£o autom√°tica</span>
<button type="button" class="btn btn-sm btn-outline-light ms-2"
onclick="window.preOrdemRealtime.forceRefresh()"
title="Atualizar agora">
<i class="fas fa-redo"></i>
</button>
`;document.body.appendChild(indicator);}if(indicator){indicator.style.display = active ? 'flex':'none';}}createNotificationContainer(){if(!document.getElementById('realtime-toast-container')){const container = document.createElement('div');container.id = 'realtime-toast-container';container.className = 'toast-container position-fixed top-0 end-0 p-3';container.style.zIndex = '9999';document.body.appendChild(container);}}showToast(message,type = 'info',icon = 'fa-info-circle',duration = 5000){const container = document.getElementById('realtime-toast-container');if(!container)return;const toastId = `toast-${Date.now()}`;const colorClass = this.getToastColorClass(type);const toastHtml = `
<div id="${toastId}" class="toast show ${colorClass}" role="alert" aria-live="assertive" aria-atomic="true">
<div class="toast-header ${colorClass}">
<i class="fas ${icon}me-2"></i>
<strong class="me-auto">Pr√©-Ordem</strong>
<small>Agora</small>
<button type="button" class="btn-close btn-close-white" data-bs-dismiss="toast" aria-label="Fechar"></button>
</div>
<div class="toast-body">
${message}</div>
</div>
`;container.insertAdjacentHTML('beforeend',toastHtml);const toastElement = document.getElementById(toastId);toastElement.classList.add('toast-enter');const closeBtn = toastElement.querySelector('.btn-close');if(closeBtn){closeBtn.addEventListener('click',()=>{this.removeToast(toastElement);});}setTimeout(()=>{this.removeToast(toastElement);},duration);this.playNotificationSound(type);}removeToast(toastElement){if(!toastElement)return;toastElement.classList.add('toast-exit');setTimeout(()=>{if(toastElement.parentNode){toastElement.parentNode.removeChild(toastElement);}},300);}getToastColorClass(type){const colorMap ={'success':'bg-success text-white','danger':'bg-danger text-white','warning':'bg-warning text-dark','info':'bg-info text-white','primary':'bg-primary text-white'};return colorMap[type] || 'bg-info text-white';}playNotificationSound(type){if(localStorage.getItem('preOrdemSoundEnabled')=== 'false'){return;}try{const audioContext = new(window.AudioContext || window.webkitAudioContext)();const oscillator = audioContext.createOscillator();const gainNode = audioContext.createGain();oscillator.connect(gainNode);gainNode.connect(audioContext.destination);const frequencies ={'success':880,'danger':440,'warning':660,'info':550};oscillator.frequency.value = frequencies[type] || 550;oscillator.type = 'sine';gainNode.gain.setValueAtTime(0.1,audioContext.currentTime);gainNode.gain.exponentialRampToValueAtTime(0.01,audioContext.currentTime + 0.3);oscillator.start(audioContext.currentTime);oscillator.stop(audioContext.currentTime + 0.3);}catch(error){}}forceRefresh(){console.log('[PreOrdemRealtime] Atualiza√ß√£o manual solicitada');this.showToast('üîÑ Atualizando...','info','fa-sync-alt',2000);this.pollForUpdates().then(()=>{location.reload();});}notifyProposalSubmitted(){console.log('[PreOrdemRealtime] Proposta enviada,aguardando confirma√ß√£o...');setTimeout(()=>{this.pollForUpdates();},1000);}notifyProposalAccepted(){console.log('[PreOrdemRealtime] Proposta aceita,atualizando...');setTimeout(()=>{this.pollForUpdates();},1000);}notifyProposalRejected(){console.log('[PreOrdemRealtime] Proposta rejeitada,atualizando...');setTimeout(()=>{this.pollForUpdates();},1000);}notifyTermsAccepted(){console.log('[PreOrdemRealtime] Termos aceitos,verificando aceita√ß√£o m√∫tua...');setTimeout(()=>{this.pollForUpdates();},1000);}toggleSound(enabled){localStorage.setItem('preOrdemSoundEnabled',enabled ? 'true':'false');}isSoundEnabled(){return localStorage.getItem('preOrdemSoundEnabled')!== 'false';}getCSRFToken(){const metaTag = document.querySelector('meta[name="csrf-token"]');if(metaTag){return metaTag.getAttribute('content');}const cookies = document.cookie.split(';');for(let cookie of cookies){const [name,value] = cookie.trim().split('=');if(name === 'csrf_token'){return value;}}return '';}setupPageListeners(){window.addEventListener('beforeunload',()=>{this.unregisterPresence();});document.addEventListener('visibilitychange',()=>{if(document.hidden){this.pauseUpdates();}else{this.resumeUpdates();}});}pauseUpdates(){console.log('[PreOrdemRealtime] Pausando atualiza√ß√µes(p√°gina oculta)');if(this.pollingInterval){clearInterval(this.pollingInterval);this.pollingInterval = null;}if(this.presenceInterval){clearInterval(this.presenceInterval);this.presenceInterval = null;}}resumeUpdates(){console.log('[PreOrdemRealtime] Retomando atualiza√ß√µes');this.pollForUpdates();if(!this.isConnected && !this.pollingInterval){this.startPolling();}if(!this.presenceInterval){this.startPresenceCheck();}this.registerPresence();}async unregisterPresence(){try{const data = JSON.stringify({user_id:this.userId,action:'leave'});navigator.sendBeacon(`/pre-ordem/${this.preOrderId}/presenca`,new Blob([data],{type:'application/json'}));}catch(error){console.error('[PreOrdemRealtime] Erro ao remover presen√ßa:',error);}}disconnect(){console.log('[PreOrdemRealtime] Desconectando...');if(this.eventSource){this.eventSource.close();this.eventSource = null;}this.stopPolling();if(this.presenceInterval){clearInterval(this.presenceInterval);this.presenceInterval = null;}this.unregisterPresence();this.isConnected = false;}}document.addEventListener('DOMContentLoaded',function(){const preOrderElement = document.querySelector('[data-pre-order-id]');if(preOrderElement){const preOrderId = preOrderElement.dataset.preOrderId;const userId = preOrderElement.dataset.userId;const userRole = preOrderElement.dataset.userRole;if(preOrderId && userId){window.preOrdemRealtime = new PreOrdemRealtime(preOrderId,userId,userRole);console.log(`[PreOrdemRealtime] Sistema inicializado para pr√©-ordem ${preOrderId}`);}}});(function(){const styles = `
.realtime-status{position:fixed;bottom:20px;left:20px;padding:8px 16px;border-radius:20px;font-size:12px;font-weight:500;z-index:9998;transition:all 0.3s ease;}.realtime-status.connected{background:#28a745;color:white;}.realtime-status.disconnected{background:#ffc107;color:#212529;}.presence-indicator{position:fixed;bottom:60px;left:20px;padding:8px 16px;border-radius:20px;background:#17a2b8;color:white;font-size:12px;font-weight:500;z-index:9998;opacity:0;transform:translateY(10px);transition:all 0.3s ease;}.presence-indicator.visible{opacity:1;transform:translateY(0);}.polling-indicator{position:fixed;bottom:20px;left:20px;padding:8px 16px;border-radius:20px;background:#6c757d;color:white;font-size:12px;font-weight:500;z-index:9998;display:flex;align-items:center;}.polling-indicator i{animation:spin 2s linear infinite;}@keyframes spin{from{transform:rotate(0deg);}to{transform:rotate(360deg);}}.status-updated{animation:statusPulse 1s ease;}@keyframes statusPulse{0%{transform:scale(1);}50%{transform:scale(1.1);}100%{transform:scale(1);}}.pulse-animation{animation:pulse 2s infinite;}@keyframes pulse{0%{box-shadow:0 0 0 0 rgba(255,193,7,0.7);}70%{box-shadow:0 0 0 10px rgba(255,193,7,0);}100%{box-shadow:0 0 0 0 rgba(255,193,7,0);}}.toast-enter{animation:toastEnter 0.3s ease;}.toast-exit{animation:toastExit 0.3s ease forwards;}@keyframes toastEnter{from{opacity:0;transform:translateX(100%);}to{opacity:1;transform:translateX(0);}}@keyframes toastExit{from{opacity:1;transform:translateX(0);}to{opacity:0;transform:translateX(100%);}}#realtime-toast-container .toast{min-width:300px;margin-bottom:10px;}#realtime-toast-container .toast-header{border-bottom:none;}@media(max-width:768px){.realtime-status,.presence-indicator,.polling-indicator{bottom:10px;left:10px;font-size:11px;padding:6px 12px;}#realtime-toast-container{left:10px;right:10px;}#realtime-toast-container .toast{min-width:auto;width:100%;}}`;const styleSheet = document.createElement('style');styleSheet.type = 'text/css';styleSheet.textContent = styles;document.head.appendChild(styleSheet);})();
class DashboardRealtime{constructor(){this.eventSource = null;this.isConnected = false;this.reconnectAttempts = 0;this.maxReconnectAttempts = 5;this.reconnectDelay = 2000;this.pollingInterval = null;this.pollingFallbackActive = false;this.init();}init(){if(!this.isDashboardPage()){return;}this.connectSSE();this.setupVisibilityHandling();this.setupNetworkHandling();}isDashboardPage(){const path = window.location.pathname;return path.includes('/cliente/dashboard')||
path.includes('/prestador/dashboard')||
document.querySelector('[data-dashboard-realtime]');}connectSSE(){if(this.eventSource){this.eventSource.close();}try{this.eventSource = new EventSource('/realtime/dashboard/stream');this.eventSource.addEventListener('open',()=>{console.log('‚úÖ Conex√£o SSE estabelecida');this.isConnected = true;this.reconnectAttempts = 0;this.setConnectionStatus(true);if(this.pollingFallbackActive){this.stopPolling();}});this.eventSource.addEventListener('message',(event)=>{try{const data = JSON.parse(event.data);this.handleUpdate(data);}catch(error){console.error('Erro ao processar mensagem SSE:',error);}});this.eventSource.addEventListener('heartbeat',(event)=>{console.debug('üíì Heartbeat recebido');});this.eventSource.addEventListener('error',(event)=>{console.error('‚ùå Erro na conex√£o SSE:',event);this.handleConnectionError();});}catch(error){console.error('Erro ao criar conex√£o SSE:',error);this.handleConnectionError();}}handleUpdate(data){console.log('üì® Atualiza√ß√£o recebida:',data);switch(data.type){case 'connected':this.showNotification('Conectado ao sistema de atualiza√ß√µes','success');break;case 'balance_updated':this.handleBalanceUpdate(data.data);break;case 'orders_updated':this.handleOrdersUpdate(data.data);break;case 'order_created':this.handleOrderCreated(data.data,data.message);break;case 'order_status_changed':this.handleOrderStatusChanged(data.data,data.message);break;case 'error':console.error('Erro do servidor:',data.message);if(data.retry){this.handleConnectionError();}break;case 'disconnected':console.log('Desconectado do servidor');this.handleConnectionError();break;default:console.log('Tipo de atualiza√ß√£o desconhecido:',data.type);}}handleBalanceUpdate(data){console.log('üí∞ Atualizando saldo:',data);const availableElements = document.querySelectorAll('[data-balance-available]');availableElements.forEach(element =>{element.textContent = this.formatCurrency(data.available);element.setAttribute('data-balance-available',data.available);});const blockedElements = document.querySelectorAll('[data-balance-blocked]');blockedElements.forEach(element =>{element.textContent = this.formatCurrency(data.blocked);element.setAttribute('data-balance-blocked',data.blocked);});const totalElements = document.querySelectorAll('[data-balance-total]');totalElements.forEach(element =>{element.textContent = this.formatCurrency(data.total);element.setAttribute('data-balance-total',data.total);});this.animateUpdate(availableElements);this.animateUpdate(blockedElements);this.showNotification('üí∞ Saldo atualizado','info');}handleOrdersUpdate(data){console.log('üìã Atualizando ordens:',data);const countElements = document.querySelectorAll('[data-orders-count]');countElements.forEach(element =>{element.textContent = data.count;element.setAttribute('data-orders-count',data.count);});this.reloadOrdersList();}handleOrderCreated(data,message){console.log('‚ú® Nova ordem criada:',data);this.showNotification(message || `Nova ordem #${data.id}criada!`,'success',5000);this.reloadOrdersList();this.updateOrdersCount();}handleOrderStatusChanged(data,message){console.log('üîÑ Status de ordem mudou:',data);this.showNotification(message || `Ordem #${data.order_id}atualizada`,'info');const orderElement = document.querySelector(`[data-order-id="${data.order_id}"]`);if(orderElement){const statusBadge = orderElement.querySelector('.order-status-badge');if(statusBadge){statusBadge.textContent = this.formatStatus(data.new_status);statusBadge.className = `order-status-badge badge ${this.getStatusClass(data.new_status)}`;}this.animateUpdate([orderElement]);}else{this.reloadOrdersList();}}reloadOrdersList(){const ordersContainer = document.querySelector('[data-orders-list]');if(!ordersContainer){return;}const loadingIndicator = document.createElement('div');loadingIndicator.className = 'text-center py-3';loadingIndicator.innerHTML = '<div class="spinner-border spinner-border-sm" role="status"></div>';ordersContainer.style.opacity = '0.6';const currentPath = window.location.pathname;fetch(currentPath,{headers:{'X-Requested-With':'XMLHttpRequest'}}).then(response => response.text()).then(html =>{const parser = new DOMParser();const doc = parser.parseFromString(html,'text/html');const newOrdersList = doc.querySelector('[data-orders-list]');if(newOrdersList){ordersContainer.innerHTML = newOrdersList.innerHTML;this.animateUpdate([ordersContainer]);}ordersContainer.style.opacity = '1';}).catch(error =>{console.error('Erro ao recarregar ordens:',error);ordersContainer.style.opacity = '1';});}updateOrdersCount(){const orderElements = document.querySelectorAll('[data-order-id]');const count = orderElements.length;const countElements = document.querySelectorAll('[data-orders-count]');countElements.forEach(element =>{element.textContent = count;element.setAttribute('data-orders-count',count);});}animateUpdate(elements){elements.forEach(element =>{element.classList.add('updated-flash');setTimeout(()=>{element.classList.remove('updated-flash');},1000);});}handleConnectionError(){this.isConnected = false;this.setConnectionStatus(false);if(this.eventSource){this.eventSource.close();this.eventSource = null;}this.reconnectAttempts++;if(this.reconnectAttempts < this.maxReconnectAttempts){const delay = this.reconnectDelay * this.reconnectAttempts;console.log(`üîÑ Tentando reconectar em ${delay}ms(tentativa ${this.reconnectAttempts}/${this.maxReconnectAttempts})`);setTimeout(()=>{this.connectSSE();},delay);}else{console.log('‚ö†Ô∏è M√°ximo de tentativas de reconex√£o atingido. Ativando polling...');this.showNotification('Modo offline:atualiza√ß√µes manuais dispon√≠veis','warning');this.startPolling();}}startPolling(){if(this.pollingInterval){return;}this.pollingFallbackActive = true;this.pollingInterval = setInterval(()=>{if(!document.hidden){this.checkUpdatesViaPolling();}},30000);console.log('üì° Polling iniciado como fallback');}stopPolling(){if(this.pollingInterval){clearInterval(this.pollingInterval);this.pollingInterval = null;this.pollingFallbackActive = false;console.log('üì° Polling parado');}}async checkUpdatesViaPolling(){try{const response = await fetch('/realtime/dashboard/check-updates',{headers:{'X-Requested-With':'XMLHttpRequest'}});if(!response.ok){throw new Error(`HTTP ${response.status}`);}const data = await response.json();if(data.success && data.has_updates){data.updates.forEach(update =>{this.handleUpdate(update);});}}catch(error){console.error('Erro ao verificar atualiza√ß√µes via polling:',error);}}setConnectionStatus(isOnline){const statusElement = document.getElementById('realtime-status');if(statusElement){if(isOnline){statusElement.className = 'realtime-status online';statusElement.innerHTML = '<i class="fas fa-circle text-success"></i> Online';statusElement.title = 'Atualiza√ß√µes em tempo real ativas';}else{statusElement.className = 'realtime-status offline';statusElement.innerHTML = '<i class="fas fa-circle text-warning"></i> Offline';statusElement.title = 'Atualiza√ß√µes em tempo real desconectadas';}}}setupVisibilityHandling(){document.addEventListener('visibilitychange',()=>{if(document.hidden){console.log('üì± P√°gina oculta - pausando atualiza√ß√µes');}else{console.log('üì± P√°gina vis√≠vel - retomando atualiza√ß√µes');if(!this.pollingFallbackActive && !this.isConnected){this.connectSSE();}if(this.pollingFallbackActive){this.checkUpdatesViaPolling();}}});}setupNetworkHandling(){window.addEventListener('online',()=>{console.log('üåê Conex√£o restaurada');this.showNotification('Conex√£o restaurada','success');this.reconnectAttempts = 0;if(this.pollingFallbackActive){this.stopPolling();}this.connectSSE();});window.addEventListener('offline',()=>{console.log('üì° Sem conex√£o com a internet');this.showNotification('Sem conex√£o com a internet','warning');if(this.eventSource){this.eventSource.close();this.eventSource = null;}this.setConnectionStatus(false);});}showNotification(message,type = 'info',duration = 3000){const notification = document.createElement('div');notification.className = `alert alert-${this.getBootstrapColor(type)}alert-dismissible fade show dashboard-notification`;notification.style.cssText = 'position:fixed;top:80px;right:20px;z-index:9999;max-width:350px;box-shadow:0 4px 6px rgba(0,0,0,0.1);';notification.innerHTML = `
${message}<button type="button" class="btn-close" data-bs-dismiss="alert"></button>
`;document.body.appendChild(notification);setTimeout(()=>{if(notification.parentNode){notification.classList.remove('show');setTimeout(()=> notification.remove(),150);}},duration);}formatCurrency(value){return new Intl.NumberFormat('pt-BR',{style:'currency',currency:'BRL'}).format(value);}formatStatus(status){const statusMap ={'aceita':'Aceita','em_andamento':'Em Andamento','aguardando_confirmacao':'Aguardando Confirma√ß√£o','concluida':'Conclu√≠da','cancelada':'Cancelada','em_contestacao':'Em Contesta√ß√£o'};return statusMap[status] || status;}getStatusClass(status){const classMap ={'aceita':'bg-info','em_andamento':'bg-primary','aguardando_confirmacao':'bg-warning','concluida':'bg-success','cancelada':'bg-secondary','em_contestacao':'bg-danger'};return classMap[status] || 'bg-secondary';}getBootstrapColor(type){const colors ={'success':'success','error':'danger','info':'info','warning':'warning'};return colors[type] || 'info';}destroy(){if(this.eventSource){this.eventSource.close();this.eventSource = null;}this.stopPolling();console.log('üßπ Recursos de tempo real limpos');}}document.addEventListener('DOMContentLoaded',function(){if(window.location.pathname.includes('/dashboard')||
document.querySelector('[data-dashboard-realtime]')){window.dashboardRealtime = new DashboardRealtime();}});window.addEventListener('beforeunload',function(){if(window.dashboardRealtime){window.dashboardRealtime.destroy();}});document.addEventListener('DOMContentLoaded',function(){const dashboardContainer = document.querySelector('[data-dashboard-realtime]');if(dashboardContainer){const refreshButton = document.createElement('button');refreshButton.className = 'btn btn-sm btn-outline-primary position-fixed';refreshButton.style.cssText = 'bottom:20px;right:20px;z-index:1000;border-radius:50%;width:50px;height:50px;';refreshButton.innerHTML = '<i class="fas fa-sync-alt"></i>';refreshButton.title = 'Atualizar dashboard manualmente';refreshButton.onclick = function(){refreshButton.innerHTML = '<i class="fas fa-sync-alt fa-spin"></i>';fetch('/realtime/dashboard/refresh',{method:'GET',headers:{'X-Requested-With':'XMLHttpRequest'}}).then(()=>{location.reload();}).catch(error =>{console.error('Erro ao atualizar:',error);refreshButton.innerHTML = '<i class="fas fa-sync-alt"></i>';});};document.body.appendChild(refreshButton);}});
class RealTimeUpdates{constructor(){this.isConnected = false;this.reconnectAttempts = 0;this.maxReconnectAttempts = 5;this.reconnectDelay = 1000;this.heartbeatInterval = null;this.updateInterval = null;this.lastUpdateTime = Date.now();this.init();}init(){this.setupConnectionStatus();this.startPolling();this.setupVisibilityHandling();this.setupNetworkHandling();}setupConnectionStatus(){if(!document.getElementById('connection-status')){const statusIndicator = document.createElement('div');statusIndicator.id = 'connection-status';statusIndicator.className = 'connection-status online';statusIndicator.innerHTML = '<i class="fas fa-wifi me-1"></i>Online';document.body.appendChild(statusIndicator);}}startPolling(){if(this.updateInterval)return;const proposalElements = document.querySelectorAll('[data-proposal-status]');if(proposalElements.length === 0)return;this.updateInterval = setInterval(()=>{if(!document.hidden && this.shouldCheckForUpdates()){this.checkForUpdates();}},10000);this.setConnectionStatus(true);}stopPolling(){if(this.updateInterval){clearInterval(this.updateInterval);this.updateInterval = null;}this.setConnectionStatus(false);}shouldCheckForUpdates(){if(document.querySelector('.modal.show')){return false;}if(document.activeElement && document.activeElement.tagName === 'INPUT'){return false;}return(Date.now()- this.lastUpdateTime)> 8000;}async checkForUpdates(){try{const proposalElements = document.querySelectorAll('[data-proposal-status]');const inviteId = this.getInviteId();if(!inviteId)return;const response = await fetch(`/convite/${inviteId}/status-updates`,{method:'GET',headers:{'X-Requested-With':'XMLHttpRequest','X-CSRFToken':this.getCSRFToken()}});if(!response.ok){throw new Error(`HTTP ${response.status}`);}const data = await response.json();if(data.success && data.has_updates){this.handleUpdates(data.updates);}this.lastUpdateTime = Date.now();this.setConnectionStatus(true);this.reconnectAttempts = 0;}catch(error){console.error('Erro ao verificar atualiza√ß√µes:',error);this.handleConnectionError();}}handleUpdates(updates){updates.forEach(update =>{switch(update.type){case 'proposal_status_changed':this.handleProposalStatusUpdate(update);break;case 'balance_updated':this.handleBalanceUpdate(update);break;case 'new_notification':this.handleNewNotification(update);break;case 'invite_expired':this.handleInviteExpired(update);break;default:console.log('Tipo de atualiza√ß√£o desconhecido:',update.type);}});}handleProposalStatusUpdate(update){this.showRealTimeNotification(update.message,'info');this.updateProposalStatusElements(update.new_status);if(update.requires_reload){setTimeout(()=>{if(confirm('O status da proposta foi atualizado. Deseja recarregar a p√°gina para ver as mudan√ßas?')){location.reload();}},2000);}}handleBalanceUpdate(update){const balanceElements = document.querySelectorAll('[data-balance]');balanceElements.forEach(element =>{element.textContent = this.formatCurrency(update.new_balance);element.setAttribute('data-balance',update.new_balance);});if(update.change > 0){this.showRealTimeNotification(`üí∞ Saldo atualizado:+${this.formatCurrency(update.change)}`,'success');}if(window.proposalInteractions && window.proposalInteractions.currentProposalId){window.proposalInteractions.checkProposalBalance(window.proposalInteractions.currentProposalId);}}handleNewNotification(update){this.showRealTimeNotification(update.message,update.level || 'info');this.updateNotificationBadge(update.unread_count);}handleInviteExpired(update){this.showRealTimeNotification('‚è∞ Este convite expirou e n√£o pode mais ser modificado.','warning');this.disableActionButtons();setTimeout(()=>{location.reload();},5000);}updateProposalStatusElements(newStatus){const statusElements = document.querySelectorAll('[data-proposal-status]');statusElements.forEach(element =>{element.setAttribute('data-proposal-status',newStatus);element.className = element.className.replace(/proposal-(pending|accepted|rejected)/g,'');if(newStatus === 'proposta_enviada'){element.classList.add('proposal-pending');}else if(newStatus === 'proposta_aceita'){element.classList.add('proposal-accepted');}else if(newStatus === 'proposta_rejeitada'){element.classList.add('proposal-rejected');}});}updateNotificationBadge(count){let badge = document.querySelector('.notification-badge');if(count > 0){if(!badge){badge = document.createElement('span');badge.className = 'notification-badge badge bg-danger position-absolute';badge.style.top = '-5px';badge.style.right = '-5px';const bellIcon = document.querySelector('.fa-bell');if(bellIcon && bellIcon.parentElement){bellIcon.parentElement.style.position = 'relative';bellIcon.parentElement.appendChild(badge);}}badge.textContent = count > 99 ? '99+':count;badge.style.display = 'inline-block';}else if(badge){badge.style.display = 'none';}}disableActionButtons(){const actionButtons = document.querySelectorAll('#btn-aceitar-proposta,.btn-reject-proposal,.btn-create-proposal,.btn-cancel-proposal');actionButtons.forEach(button =>{button.disabled = true;button.classList.add('disabled');button.title = 'Convite expirado';});}handleConnectionError(){this.setConnectionStatus(false);this.reconnectAttempts++;if(this.reconnectAttempts < this.maxReconnectAttempts){setTimeout(()=>{this.startPolling();},this.reconnectDelay * this.reconnectAttempts);}else{this.showRealTimeNotification('‚ö†Ô∏è Conex√£o perdida. Algumas atualiza√ß√µes podem n√£o aparecer automaticamente.','warning');}}setConnectionStatus(isOnline){this.isConnected = isOnline;const statusElement = document.getElementById('connection-status');if(statusElement){if(isOnline){statusElement.className = 'connection-status online';statusElement.innerHTML = '<i class="fas fa-wifi me-1"></i>Online';}else{statusElement.className = 'connection-status offline';statusElement.innerHTML = '<i class="fas fa-wifi-slash me-1"></i>Offline';}}}setupVisibilityHandling(){document.addEventListener('visibilitychange',()=>{if(document.hidden){this.stopPolling();}else{this.startPolling();setTimeout(()=> this.checkForUpdates(),1000);}});}setupNetworkHandling(){window.addEventListener('online',()=>{this.showRealTimeNotification('üåê Conex√£o restaurada','success');this.reconnectAttempts = 0;this.startPolling();});window.addEventListener('offline',()=>{this.showRealTimeNotification('üì° Sem conex√£o com a internet','warning');this.stopPolling();});}showRealTimeNotification(message,type = 'info'){if(window.proposalInteractions){window.proposalInteractions.showNotification(message,type);return;}const notification = document.createElement('div');notification.className = `alert alert-${this.getBootstrapColor(type)}alert-dismissible fade show position-fixed`;notification.style.top = '20px';notification.style.right = '20px';notification.style.zIndex = '9999';notification.style.maxWidth = '300px';notification.innerHTML = `
${message}<button type="button" class="btn-close" data-bs-dismiss="alert"></button>
`;document.body.appendChild(notification);setTimeout(()=>{if(notification.parentNode){notification.remove();}},5000);}getInviteId(){const urlMatch = window.location.pathname.match(/\/convite\/(\d+)/);if(urlMatch){return urlMatch[1];}const inviteElement = document.querySelector('[data-invite-id]');if(inviteElement){return inviteElement.getAttribute('data-invite-id');}return null;}getCSRFToken(){const metaTag = document.querySelector('meta[name=csrf-token]');return metaTag ? metaTag.getAttribute('content'):'';}formatCurrency(value){return new Intl.NumberFormat('pt-BR',{style:'currency',currency:'BRL'}).format(value);}getBootstrapColor(type){const colors ={'success':'success','error':'danger','info':'info','warning':'warning'};return colors[type] || 'info';}destroy(){this.stopPolling();if(this.heartbeatInterval){clearInterval(this.heartbeatInterval);}const statusElement = document.getElementById('connection-status');if(statusElement){statusElement.remove();}}}document.addEventListener('DOMContentLoaded',function(){if(window.location.pathname.includes('/convite/')||
document.querySelector('[data-proposal-status]')){window.realTimeUpdates = new RealTimeUpdates();}});window.addEventListener('beforeunload',function(){if(window.realTimeUpdates){window.realTimeUpdates.destroy();}});
{% extends "prestador/base_prestador.html" %}

{% block title %}Convite: {{ invite.service_title }} - Sistema Combinado{% endblock %}

{% block prestador_content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h1><i class="fas fa-envelope-open-text me-2"></i>Detalhes do Convite</h1>
    <a href="{{ url_for('prestador.convites') }}" class="btn btn-secondary">
        <i class="fas fa-arrow-left me-2"></i>Voltar
    </a>
</div>

<!-- Status do Convite -->
<div class="row mb-4">
    <div class="col-12">
        {% set current_state = invite.get_current_state() %}
        {% set state_info = invite.get_state_description() %}
        
        <div class="alert 
            {% if current_state.value == 'pendente' %}alert-warning
            {% elif current_state.value == 'aceito' %}alert-success
            {% elif current_state.value == 'recusado' %}alert-danger
            {% elif current_state.value == 'expirado' %}alert-secondary
            {% elif current_state.value == 'convertido' %}alert-primary
            {% else %}alert-secondary{% endif %}" role="alert">
            
            <div class="d-flex align-items-center">
                <div class="me-3">
                    {% if current_state.value == 'pendente' %}
                        <i class="fas fa-clock fa-2x"></i>
                    {% elif current_state.value == 'aceito' %}
                        <i class="fas fa-check-circle fa-2x"></i>
                    {% elif current_state.value == 'recusado' %}
                        <i class="fas fa-ban fa-2x"></i>
                    {% elif current_state.value == 'expirado' %}
                        <i class="fas fa-calendar-times fa-2x"></i>
                    {% elif current_state.value == 'convertido' %}
                        <i class="fas fa-exchange-alt fa-2x"></i>
                    {% endif %}
                </div>
                <div>
                    <h5 class="mb-1">{{ state_info.status }}</h5>
                    <p class="mb-0">{{ state_info.prestador_message }}</p>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Detalhes do Convite -->
<div class="row">
    <div class="col-lg-8 col-md-7">
        <div class="card mb-3">
            <div class="card-header">
                <h5 class="mb-0"><i class="fas fa-info-circle me-2"></i>Informações do Serviço</h5>
            </div>
            <div class="card-body">
                <h4 class="text-primary mb-3">{{ invite.service_title }}</h4>
                
                <div class="mb-4">
                    <h6><i class="fas fa-align-left me-2"></i>Descrição:</h6>
                    <p class="text-muted">{{ invite.service_description }}</p>
                </div>
                
                <div class="row mb-3">
                    <div class="col-sm-6">
                        <h6><i class="fas fa-user me-2"></i>Cliente:</h6>
                        <p>{{ invite.client.nome }}</p>
                    </div>
                    <div class="col-sm-6">
                        <h6><i class="fas fa-envelope me-2"></i>Email:</h6>
                        <p>{{ invite.client.email }}</p>
                    </div>
                </div>
                
                <div class="row mb-3">
                    <div class="col-sm-6">
                        <h6><i class="fas fa-calendar me-2"></i>Data de Entrega:</h6>
                        <p class="text-primary fw-bold">{{ invite.delivery_date.strftime('%d/%m/%Y') }}</p>
                    </div>
                    <div class="col-sm-6">
                        <h6><i class="fas fa-calendar-times me-2"></i>Expira em:</h6>
                        <p class="text-danger">{{ invite.expires_at.strftime('%d/%m/%Y %H:%M') }}</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-lg-4 col-md-5">
        <!-- Informações Financeiras -->
        <div class="card mb-3">
            <div class="card-header">
                <h6 class="mb-0"><i class="fas fa-dollar-sign me-2"></i>Valores</h6>
            </div>
            <div class="card-body">
                <div class="mb-3">
                    <label class="form-label">Valor do Serviço:</label>
                    <div class="h3 text-primary mb-2">
                        <i class="fas fa-tag me-2"></i>{{ invite.original_value|format_currency }}
                    </div>
                </div>
                
                <hr class="my-3">
                
                <div class="mb-3">
                    <label class="form-label">Taxa de Contestação:</label>
                    <div class="text-warning">{{ contestation_fee|format_currency }}</div>
                    <small class="text-muted">Necessária para aceitar</small>
                </div>
            </div>
        </div>
        
        <!-- Seu Saldo -->
        <div class="card mb-3">
            <div class="card-header">
                <h6 class="mb-0"><i class="fas fa-wallet me-2"></i>Seu Saldo</h6>
            </div>
            <div class="card-body">
                {% if user.wallet %}
                    <div class="h5 text-success">{{ user.wallet.balance|format_currency }}</div>
                    {% if user.wallet.balance >= contestation_fee %}
                        <small class="text-success">
                            <i class="fas fa-check me-1"></i>Saldo suficiente
                        </small>
                    {% else %}
                        <small class="text-danger">
                            <i class="fas fa-exclamation-triangle me-1"></i>Saldo insuficiente
                        </small>
                        <div class="mt-2">
                            <a href="{{ url_for('prestador.solicitar_tokens') }}" class="btn btn-sm btn-outline-primary">
                                <i class="fas fa-plus me-1"></i>Adicionar Saldo
                            </a>
                        </div>
                    {% endif %}
                {% else %}
                    <div class="text-muted">Carteira não encontrada</div>
                {% endif %}
            </div>
        </div>
        
        <!-- Ações Simplificadas -->
        <div class="card">
            <div class="card-header">
                <h6 class="mb-0"><i class="fas fa-hand-pointer me-2"></i>O que deseja fazer?</h6>
            </div>
            <div class="card-body">
                {% set current_state = invite.get_current_state() %}
                
                <!-- Convite já finalizado -->
                {% if current_state.value in ['aceito', 'convertido', 'recusado', 'expirado'] or invite.status == 'convertido_pre_ordem' %}
                    <div class="alert alert-{% if current_state.value == 'aceito' or invite.status == 'convertido_pre_ordem' %}success{% elif current_state.value == 'convertido' %}primary{% else %}secondary{% endif %} text-center mb-3">
                        <i class="fas fa-{% if current_state.value == 'aceito' or invite.status == 'convertido_pre_ordem' %}check-circle{% elif current_state.value == 'convertido' %}exchange-alt{% else %}info-circle{% endif %} me-2"></i>
                        {% if invite.status == 'convertido_pre_ordem' %}
                            Convite aceito! Pré-ordem criada para negociação.
                            {% if invite.pre_order %}
                                <div class="mt-2">
                                    <a href="{{ url_for('pre_ordem.ver_detalhes', pre_order_id=invite.pre_order.id) }}" class="btn btn-sm btn-success">
                                        <i class="fas fa-handshake me-1"></i>Ver Pré-Ordem
                                    </a>
                                </div>
                            {% endif %}
                        {% elif current_state.value == 'aceito' %}
                            Convite aceito! Aguardando conversão em ordem.
                        {% elif current_state.value == 'convertido' %}
                            Convertido em ordem de serviço.
                            {% if invite.order_id %}
                                <div class="mt-2">
                                    <a href="{{ url_for('prestador.ver_ordem', order_id=invite.order_id) }}" class="btn btn-sm btn-primary">
                                        <i class="fas fa-eye me-1"></i>Ver Ordem
                                    </a>
                                </div>
                            {% endif %}
                        {% elif current_state.value == 'recusado' %}
                            Este convite foi recusado.
                        {% elif current_state.value == 'expirado' %}
                            Este convite expirou.
                        {% endif %}
                    </div>
                    
                    <!-- Excluir convites finalizados -->
                    {% if invite.status in ['recusado', 'expirado'] %}
                        <form method="POST" action="{{ url_for('prestador.excluir_convite', invite_id=invite.id) }}" 
                              onsubmit="return confirm('Excluir este convite?')">
                            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                            <button type="submit" class="btn btn-outline-danger w-100">
                                <i class="fas fa-trash me-2"></i>Excluir Convite
                            </button>
                        </form>
                    {% endif %}
                    
                {% else %}
                    <!-- Convite pendente - Mostrar apenas Aceitar e Recusar -->
                    
                    <!-- Botão Aceitar -->
                    <button type="button" 
                            class="btn btn-success btn-lg w-100 mb-3" 
                            style="min-height: 56px; font-size: 18px;"
                            data-bs-toggle="modal" 
                            data-bs-target="#acceptModal"
                            {% if user.wallet and user.wallet.balance < contestation_fee %}disabled{% endif %}>
                        <i class="fas fa-check me-2"></i>Aceitar Convite
                    </button>
                    
                    {% if user.wallet and user.wallet.balance < contestation_fee %}
                        <div class="alert alert-warning py-2 mb-3">
                            <small><i class="fas fa-exclamation-triangle me-1"></i>Adicione saldo para aceitar</small>
                        </div>
                    {% endif %}
                    
                    <!-- Botão Recusar -->
                    <button type="button" 
                            class="btn btn-outline-danger btn-lg w-100" 
                            style="min-height: 56px; font-size: 18px;"
                            data-bs-toggle="modal" 
                            data-bs-target="#rejectModal">
                        <i class="fas fa-times me-2"></i>Recusar Convite
                    </button>
                    
                    <!-- Informação sobre negociação -->
                    <div class="alert alert-info mt-3 mb-0">
                        <small>
                            <i class="fas fa-info-circle me-1"></i>
                            <strong>Quer negociar o valor?</strong><br>
                            Aceite o convite primeiro. Depois você poderá negociar na tela de pré-ordem.
                        </small>
                    </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- Modal: Aceitar Convite -->
<div class="modal fade" id="acceptModal" tabindex="-1" aria-labelledby="acceptModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header bg-success text-white">
                <h5 class="modal-title" id="acceptModalLabel">
                    <i class="fas fa-check-circle me-2"></i>Aceitar Convite
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Fechar"></button>
            </div>
            <form method="POST" action="{{ url_for('prestador.aceitar_convite', token=invite.token) }}">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                <div class="modal-body">
                    <div class="alert alert-info">
                        <i class="fas fa-info-circle me-2"></i>
                        Ao aceitar, <strong>{{ contestation_fee|format_currency }}</strong> será reservado como taxa de contestação.
                    </div>
                    
                    <div class="card bg-light mb-3">
                        <div class="card-body">
                            <h6 class="card-title">Resumo do Serviço:</h6>
                            <ul class="list-unstyled mb-0">
                                <li><strong>Serviço:</strong> {{ invite.service_title }}</li>
                                <li><strong>Valor:</strong> <span class="text-success fw-bold">{{ invite.original_value|format_currency }}</span></li>
                                <li><strong>Prazo:</strong> {{ invite.delivery_date.strftime('%d/%m/%Y') }}</li>
                            </ul>
                        </div>
                    </div>
                    
                    <p class="text-muted small mb-0">
                        <i class="fas fa-lightbulb me-1"></i>
                        Após aceitar, você poderá negociar valores na tela de pré-ordem antes de iniciar o serviço.
                    </p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="submit" class="btn btn-success btn-lg">
                        <i class="fas fa-check me-2"></i>Confirmar
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Modal: Recusar Convite -->
<div class="modal fade" id="rejectModal" tabindex="-1" aria-labelledby="rejectModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header bg-danger text-white">
                <h5 class="modal-title" id="rejectModalLabel">
                    <i class="fas fa-times-circle me-2"></i>Recusar Convite
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Fechar"></button>
            </div>
            <form method="POST" action="{{ url_for('prestador.recusar_convite', token=invite.token) }}">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                <div class="modal-body">
                    <div class="alert alert-warning">
                        <i class="fas fa-exclamation-triangle me-2"></i>
                        Esta ação não pode ser desfeita.
                    </div>
                    
                    <div class="mb-3">
                        <label for="reason" class="form-label">Motivo da recusa (opcional):</label>
                        <textarea class="form-control" id="reason" name="reason" rows="3" 
                                  placeholder="Explique brevemente por que não pode aceitar..."
                                  style="min-height: 100px;"></textarea>
                        <div class="form-text">Ajuda o cliente a entender sua decisão</div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="submit" class="btn btn-danger btn-lg">
                        <i class="fas fa-times me-2"></i>Confirmar Recusa
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Confirmação de aceitação
    const acceptForm = document.querySelector('#acceptModal form');
    if (acceptForm) {
        acceptForm.addEventListener('submit', function(e) {
            const btn = this.querySelector('button[type="submit"]');
            btn.disabled = true;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Processando...';
        });
    }
    
    // Confirmação de recusa
    const rejectForm = document.querySelector('#rejectModal form');
    if (rejectForm) {
        rejectForm.addEventListener('submit', function(e) {
            if (!confirm('Tem certeza que deseja recusar este convite?')) {
                e.preventDefault();
                return false;
            }
            const btn = this.querySelector('button[type="submit"]');
            btn.disabled = true;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Processando...';
        });
    }
});
</script>
{% endblock %}

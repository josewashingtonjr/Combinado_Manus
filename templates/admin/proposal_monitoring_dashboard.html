{% extends "admin/base_admin.html" %}

{% block title %}Dashboard de Monitoramento de Propostas{% endblock %}

{% block extra_css %}
<style>
.metric-card {
    background: white;
    border-radius: 8px;
    padding: 20px;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    margin-bottom: 20px;
}

.metric-value {
    font-size: 2.5em;
    font-weight: bold;
    color: #2c3e50;
}

.metric-label {
    color: #7f8c8d;
    font-size: 0.9em;
    text-transform: uppercase;
    letter-spacing: 1px;
}

.trend-up {
    color: #27ae60;
}

.trend-down {
    color: #e74c3c;
}

.trend-stable {
    color: #f39c12;
}

.alert-badge {
    display: inline-block;
    padding: 4px 8px;
    border-radius: 12px;
    font-size: 0.8em;
    font-weight: bold;
    text-transform: uppercase;
}

.alert-critical {
    background-color: #e74c3c;
    color: white;
}

.alert-high {
    background-color: #f39c12;
    color: white;
}

.alert-medium {
    background-color: #3498db;
    color: white;
}

.alert-low {
    background-color: #95a5a6;
    color: white;
}

.chart-container {
    height: 300px;
    margin: 20px 0;
}

.top-users-list {
    max-height: 300px;
    overflow-y: auto;
}

.user-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 10px;
    border-bottom: 1px solid #ecf0f1;
}

.user-item:last-child {
    border-bottom: none;
}

.refresh-btn {
    position: fixed;
    bottom: 20px;
    right: 20px;
    z-index: 1000;
}
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <h1 class="h3 mb-4">
                <i class="fas fa-chart-line"></i>
                Dashboard de Monitoramento de Propostas
            </h1>
        </div>
    </div>

    <!-- Métricas Principais -->
    <div class="row">
        <div class="col-md-3">
            <div class="metric-card">
                <div class="metric-value">{{ metrics_summary.total_proposals }}</div>
                <div class="metric-label">Propostas (30 dias)</div>
                <div class="mt-2">
                    <span class="trend-{{ metrics_summary.trend }}">
                        <i class="fas fa-arrow-{{ 'up' if metrics_summary.trend == 'increasing' else 'down' if metrics_summary.trend == 'decreasing' else 'right' }}"></i>
                        {{ metrics_summary.trend|title }}
                    </span>
                </div>
            </div>
        </div>
        
        <div class="col-md-3">
            <div class="metric-card">
                <div class="metric-value">{{ "%.1f"|format(metrics_summary.approval_rate) }}%</div>
                <div class="metric-label">Taxa de Aprovação</div>
                <div class="mt-2">
                    <small class="text-muted">
                        {{ metrics_summary.total_approved }} aprovadas / {{ metrics_summary.total_rejected }} rejeitadas
                    </small>
                </div>
            </div>
        </div>
        
        <div class="col-md-3">
            <div class="metric-card">
                <div class="metric-value">{{ "%.1f"|format(metrics_summary.daily_average) }}</div>
                <div class="metric-label">Média Diária</div>
                <div class="mt-2">
                    <small class="text-muted">
                        Baseado em {{ metrics_summary.metrics_count }} dias
                    </small>
                </div>
            </div>
        </div>
        
        <div class="col-md-3">
            <div class="metric-card">
                <div class="metric-value">{{ daily_metric.total_proposals if daily_metric else 0 }}</div>
                <div class="metric-label">Propostas Hoje</div>
                <div class="mt-2">
                    {% if daily_metric %}
                    <small class="text-muted">
                        {{ daily_metric.proposals_approved }} aprovadas
                    </small>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <!-- Alertas Ativos -->
    <div class="row">
        <div class="col-md-6">
            <div class="metric-card">
                <h5><i class="fas fa-exclamation-triangle"></i> Alertas Ativos</h5>
                
                {% if critical_alerts %}
                <div class="mb-3">
                    <h6><span class="alert-badge alert-critical">Críticos ({{ critical_alerts|length }})</span></h6>
                    {% for alert in critical_alerts %}
                    <div class="alert alert-danger alert-sm">
                        <strong>{{ alert.title }}</strong><br>
                        <small>{{ alert.description[:100] }}...</small>
                        <div class="mt-1">
                            <small class="text-muted">{{ alert.created_at.strftime('%d/%m/%Y %H:%M') }}</small>
                        </div>
                    </div>
                    {% endfor %}
                </div>
                {% endif %}
                
                {% if high_alerts %}
                <div class="mb-3">
                    <h6><span class="alert-badge alert-high">Altos ({{ high_alerts|length }})</span></h6>
                    {% for alert in high_alerts[:3] %}
                    <div class="alert alert-warning alert-sm">
                        <strong>{{ alert.title }}</strong><br>
                        <small>{{ alert.description[:80] }}...</small>
                    </div>
                    {% endfor %}
                    {% if high_alerts|length > 3 %}
                    <small class="text-muted">... e mais {{ high_alerts|length - 3 }} alertas</small>
                    {% endif %}
                </div>
                {% endif %}
                
                <div class="text-center">
                    <a href="{{ url_for('admin_proposal_monitoring.alertas') }}" class="btn btn-outline-primary btn-sm">
                        Ver Todos os Alertas
                    </a>
                </div>
            </div>
        </div>
        
        <div class="col-md-6">
            <div class="metric-card">
                <h5><i class="fas fa-chart-pie"></i> Estatísticas de Alertas (30 dias)</h5>
                
                <div class="row">
                    <div class="col-6">
                        <div class="text-center">
                            <div class="metric-value" style="font-size: 1.8em;">{{ alert_stats.total_alerts }}</div>
                            <div class="metric-label">Total de Alertas</div>
                        </div>
                    </div>
                    <div class="col-6">
                        <div class="text-center">
                            <div class="metric-value" style="font-size: 1.8em;">{{ "%.1f"|format(alert_stats.resolution_rate) }}%</div>
                            <div class="metric-label">Taxa de Resolução</div>
                        </div>
                    </div>
                </div>
                
                <div class="mt-3">
                    <h6>Por Severidade:</h6>
                    {% for severity, count in alert_stats.by_severity.items() %}
                    <div class="d-flex justify-content-between">
                        <span class="alert-badge alert-{{ severity }}">{{ severity|title }}</span>
                        <span>{{ count }}</span>
                    </div>
                    {% endfor %}
                </div>
                
                {% if alert_stats.average_resolution_time_hours %}
                <div class="mt-2">
                    <small class="text-muted">
                        Tempo médio de resolução: {{ "%.1f"|format(alert_stats.average_resolution_time_hours) }} horas
                    </small>
                </div>
                {% endif %}
            </div>
        </div>
    </div>

    <!-- Top Usuários e Análise de Valores -->
    <div class="row">
        <div class="col-md-6">
            <div class="metric-card">
                <h5><i class="fas fa-users"></i> Top Prestadores (30 dias)</h5>
                <div class="top-users-list">
                    {% for prestador in top_users.top_prestadores %}
                    <div class="user-item">
                        <div>
                            <strong>{{ prestador.nome }}</strong><br>
                            <small class="text-muted">{{ prestador.email }}</small>
                        </div>
                        <div class="text-right">
                            <div><strong>{{ prestador.proposals_count }}</strong> propostas</div>
                            <small class="text-muted">
                                Aumento médio: R$ {{ "%.2f"|format(prestador.avg_increase) }}
                            </small>
                        </div>
                    </div>
                    {% endfor %}
                </div>
                
                <div class="text-center mt-3">
                    <a href="{{ url_for('admin_proposal_monitoring.metricas') }}" class="btn btn-outline-primary btn-sm">
                        Ver Métricas Detalhadas
                    </a>
                </div>
            </div>
        </div>
        
        <div class="col-md-6">
            <div class="metric-card">
                <h5><i class="fas fa-dollar-sign"></i> Análise de Valores (30 dias)</h5>
                
                <div class="row">
                    <div class="col-6">
                        <div class="text-center">
                            <div class="metric-value" style="font-size: 1.5em;">{{ value_analysis.increase_analysis.count }}</div>
                            <div class="metric-label">Aumentos</div>
                            <small class="text-muted">{{ "%.1f"|format(value_analysis.increase_analysis.percentage_with_increase) }}%</small>
                        </div>
                    </div>
                    <div class="col-6">
                        <div class="text-center">
                            <div class="metric-value" style="font-size: 1.5em;">{{ value_analysis.decrease_analysis.count }}</div>
                            <div class="metric-label">Diminuições</div>
                            <small class="text-muted">{{ "%.1f"|format(value_analysis.decrease_analysis.percentage_with_decrease) }}%</small>
                        </div>
                    </div>
                </div>
                
                <div class="mt-3">
                    <h6>Distribuição por Faixa de Valor:</h6>
                    {% for range, count in value_analysis.value_ranges.items() %}
                    <div class="d-flex justify-content-between">
                        <span>R$ {{ range }}</span>
                        <span>{{ count }} propostas</span>
                    </div>
                    {% endfor %}
                </div>
                
                <div class="mt-2">
                    <small class="text-muted">
                        Valor médio proposto: R$ {{ "%.2f"|format(value_analysis.average_values.proposed) }}
                    </small>
                </div>
            </div>
        </div>
    </div>

    <!-- Links Rápidos -->
    <div class="row">
        <div class="col-12">
            <div class="metric-card">
                <h5><i class="fas fa-link"></i> Acesso Rápido</h5>
                <div class="row">
                    <div class="col-md-3">
                        <a href="{{ url_for('admin_proposal_monitoring.alertas') }}" class="btn btn-outline-danger btn-block">
                            <i class="fas fa-exclamation-triangle"></i>
                            Gerenciar Alertas
                        </a>
                    </div>
                    <div class="col-md-3">
                        <a href="{{ url_for('admin_proposal_monitoring.metricas') }}" class="btn btn-outline-info btn-block">
                            <i class="fas fa-chart-bar"></i>
                            Métricas Detalhadas
                        </a>
                    </div>
                    <div class="col-md-3">
                        <a href="{{ url_for('admin_proposal_monitoring.auditoria') }}" class="btn btn-outline-secondary btn-block">
                            <i class="fas fa-search"></i>
                            Log de Auditoria
                        </a>
                    </div>
                    <div class="col-md-3">
                        <button onclick="verificarAlertas()" class="btn btn-outline-warning btn-block">
                            <i class="fas fa-sync"></i>
                            Verificar Alertas
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Botão de Refresh -->
<button onclick="location.reload()" class="btn btn-primary btn-lg refresh-btn" title="Atualizar Dashboard">
    <i class="fas fa-sync-alt"></i>
</button>
{% endblock %}

{% block extra_js %}
<script>
function verificarAlertas() {
    const btn = event.target;
    const originalText = btn.innerHTML;
    
    btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Verificando...';
    btn.disabled = true;
    
    fetch('{{ url_for("admin_proposal_monitoring.verificar_alertas") }}', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert(`Verificação concluída! ${data.alerts_created} novos alertas criados.`);
            if (data.alerts_created > 0) {
                location.reload();
            }
        } else {
            alert('Erro na verificação: ' + data.error);
        }
    })
    .catch(error => {
        alert('Erro na verificação: ' + error);
    })
    .finally(() => {
        btn.innerHTML = originalText;
        btn.disabled = false;
    });
}

// Auto-refresh a cada 5 minutos
setInterval(() => {
    fetch('{{ url_for("admin_proposal_monitoring.estatisticas_rapidas") }}')
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Atualizar apenas os números principais sem recarregar a página
            console.log('Estatísticas atualizadas:', data.data.last_updated);
        }
    })
    .catch(error => console.error('Erro ao atualizar estatísticas:', error));
}, 300000); // 5 minutos
</script>
{% endblock %}
{% extends "admin/base_admin.html" %}

{% block title %}Relatórios - Admin{% endblock %}

{% block admin_content %}
<h2 class="mb-4"><i class="fas fa-chart-bar me-2"></i>Relatórios e Estatísticas</h2>

<!-- Cards de Métricas Gerais -->
<div class="row mb-4">
    <div class="col-md-3">
        <div class="card text-center border-0 shadow-sm">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <h6 class="card-title text-muted mb-1">USUÁRIOS</h6>
                        <h3 class="mb-0 text-primary">{{ stats.total_usuarios if stats else 0 }}</h3>
                    </div>
                    <div class="text-primary">
                        <i class="fas fa-users fa-2x"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card text-center border-0 shadow-sm">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <h6 class="card-title text-muted mb-1">CONTRATOS</h6>
                        <h3 class="mb-0 text-success">{{ stats.contratos_ativos if stats else 0 }}</h3>
                    </div>
                    <div class="text-success">
                        <i class="fas fa-file-contract fa-2x"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card text-center border-0 shadow-sm">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <h6 class="card-title text-muted mb-1">TOKENS</h6>
                        <h3 class="mb-0 text-warning">{{ "{:,.0f}".format(stats.tokens_em_circulacao) if stats else 0 }}</h3>
                    </div>
                    <div class="text-warning">
                        <i class="fas fa-coins fa-2x"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card text-center border-0 shadow-sm">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <h6 class="card-title text-muted mb-1">RECEITA</h6>
                        <h3 class="mb-0 text-info">{{ "{:,.0f}".format(stats.receita_mes) if stats else 0 }} tokens</h3>
                    </div>
                    <div class="text-info">
                        <i class="fas fa-chart-line fa-2x"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Navegação por Abas -->
<ul class="nav nav-tabs mb-4" id="reportTabs" role="tablist">
    <li class="nav-item" role="presentation">
        <button class="nav-link active" id="contratos-tab" data-bs-toggle="tab" data-bs-target="#contratos" type="button" role="tab">
            <i class="fas fa-file-contract me-2"></i>Contratos
        </button>
    </li>
    <li class="nav-item" role="presentation">
        <button class="nav-link" id="usuarios-tab" data-bs-toggle="tab" data-bs-target="#usuarios" type="button" role="tab">
            <i class="fas fa-users me-2"></i>Usuários
        </button>
    </li>
    <li class="nav-item" role="presentation">
        <button class="nav-link" id="financeiro-tab" data-bs-toggle="tab" data-bs-target="#financeiro" type="button" role="tab">
            <i class="fas fa-chart-line me-2"></i>Financeiro
        </button>
    </li>
    <li class="nav-item" role="presentation">
        <button class="nav-link" id="convites-tab" data-bs-toggle="tab" data-bs-target="#convites" type="button" role="tab">
            <i class="fas fa-envelope-open-text me-2"></i>Convites
        </button>
    </li>
</ul>

<!-- Conteúdo das Abas -->
<div class="tab-content" id="reportTabsContent">
    <!-- Aba Contratos -->
    <div class="tab-pane fade show active" id="contratos" role="tabpanel">
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="mb-0"><i class="fas fa-filter me-2"></i>Filtros - Relatório de Contratos</h5>
            </div>
            <div class="card-body">
                <form method="GET" action="{{ url_for('admin.relatorios_contratos') }}" class="row g-3">
                    <div class="col-md-3">
                        <label class="form-label">Data Inicial</label>
                        <input type="date" name="start_date" class="form-control" value="{{ request.args.get('start_date', '') }}">
                    </div>
                    <div class="col-md-3">
                        <label class="form-label">Data Final</label>
                        <input type="date" name="end_date" class="form-control" value="{{ request.args.get('end_date', '') }}">
                    </div>
                    <div class="col-md-3">
                        <label class="form-label">Status</label>
                        <select name="status" class="form-select">
                            <option value="todos">Todos os Status</option>
                            <option value="disponivel" {{ 'selected' if request.args.get('status') == 'disponivel' }}>Disponível</option>
                            <option value="aceita" {{ 'selected' if request.args.get('status') == 'aceita' }}>Aceita</option>
                            <option value="em_andamento" {{ 'selected' if request.args.get('status') == 'em_andamento' }}>Em Andamento</option>
                            <option value="concluida" {{ 'selected' if request.args.get('status') == 'concluida' }}>Concluída</option>
                            <option value="cancelada" {{ 'selected' if request.args.get('status') == 'cancelada' }}>Cancelada</option>
                            <option value="disputada" {{ 'selected' if request.args.get('status') == 'disputada' }}>Disputada</option>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <label class="form-label">&nbsp;</label>
                        <button type="submit" class="btn btn-primary w-100">
                            <i class="fas fa-search me-1"></i>Filtrar
                        </button>
                    </div>
                </form>
            </div>
        </div>
        
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0">Exportar Relatório de Contratos</h5>
                <div>
                    <a href="{{ url_for('admin.export_contracts', format='excel') }}{{ '?' + request.query_string.decode() if request.query_string }}" 
                       class="btn btn-outline-success btn-sm me-2">
                        <i class="fas fa-file-excel me-1"></i>Excel
                    </a>
                    <a href="{{ url_for('admin.export_contracts', format='pdf') }}{{ '?' + request.query_string.decode() if request.query_string }}" 
                       class="btn btn-outline-danger btn-sm">
                        <i class="fas fa-file-pdf me-1"></i>PDF
                    </a>
                </div>
            </div>
            <div class="card-body">
                <p class="text-muted">Relatório completo de contratos/ordens com filtros aplicados. Inclui dados do cliente, prestador, valores e status.</p>
            </div>
        </div>
    </div>

    <!-- Aba Usuários -->
    <div class="tab-pane fade" id="usuarios" role="tabpanel">
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="mb-0"><i class="fas fa-filter me-2"></i>Filtros - Relatório de Usuários</h5>
            </div>
            <div class="card-body">
                <form method="GET" action="{{ url_for('admin.relatorios_usuarios') }}" class="row g-3">
                    <div class="col-md-3">
                        <label class="form-label">Data Inicial</label>
                        <input type="date" name="start_date" class="form-control" value="{{ request.args.get('start_date', '') }}">
                    </div>
                    <div class="col-md-3">
                        <label class="form-label">Data Final</label>
                        <input type="date" name="end_date" class="form-control" value="{{ request.args.get('end_date', '') }}">
                    </div>
                    <div class="col-md-2">
                        <label class="form-label">Tipo</label>
                        <select name="user_type" class="form-select">
                            <option value="todos">Todos</option>
                            <option value="cliente" {{ 'selected' if request.args.get('user_type') == 'cliente' }}>Cliente</option>
                            <option value="prestador" {{ 'selected' if request.args.get('user_type') == 'prestador' }}>Prestador</option>
                            <option value="dual" {{ 'selected' if request.args.get('user_type') == 'dual' }}>Dual</option>
                        </select>
                    </div>
                    <div class="col-md-2">
                        <label class="form-label">Status</label>
                        <select name="status" class="form-select">
                            <option value="todos">Todos</option>
                            <option value="ativo" {{ 'selected' if request.args.get('status') == 'ativo' }}>Ativo</option>
                            <option value="inativo" {{ 'selected' if request.args.get('status') == 'inativo' }}>Inativo</option>
                        </select>
                    </div>
                    <div class="col-md-2">
                        <label class="form-label">&nbsp;</label>
                        <button type="submit" class="btn btn-primary w-100">
                            <i class="fas fa-search me-1"></i>Filtrar
                        </button>
                    </div>
                </form>
            </div>
        </div>
        
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0">Exportar Relatório de Usuários</h5>
                <div>
                    <a href="{{ url_for('admin.export_users', format='excel') }}{{ '?' + request.query_string.decode() if request.query_string }}" 
                       class="btn btn-outline-success btn-sm me-2">
                        <i class="fas fa-file-excel me-1"></i>Excel
                    </a>
                    <a href="{{ url_for('admin.export_users', format='pdf') }}{{ '?' + request.query_string.decode() if request.query_string }}" 
                       class="btn btn-outline-danger btn-sm">
                        <i class="fas fa-file-pdf me-1"></i>PDF
                    </a>
                </div>
            </div>
            <div class="card-body">
                <p class="text-muted">Relatório completo de usuários com informações de carteira, transações e estatísticas de uso.</p>
            </div>
        </div>
    </div>

    <!-- Aba Financeiro -->
    <div class="tab-pane fade" id="financeiro" role="tabpanel">
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="mb-0"><i class="fas fa-filter me-2"></i>Filtros - Relatório Financeiro</h5>
            </div>
            <div class="card-body">
                <form method="GET" action="{{ url_for('admin.relatorios_financeiro') }}" class="row g-3">
                    <div class="col-md-4">
                        <label class="form-label">Data Inicial</label>
                        <input type="date" name="start_date" class="form-control" value="{{ request.args.get('start_date', '') }}">
                    </div>
                    <div class="col-md-4">
                        <label class="form-label">Data Final</label>
                        <input type="date" name="end_date" class="form-control" value="{{ request.args.get('end_date', '') }}">
                    </div>
                    <div class="col-md-4">
                        <label class="form-label">&nbsp;</label>
                        <button type="submit" class="btn btn-primary w-100">
                            <i class="fas fa-search me-1"></i>Filtrar
                        </button>
                    </div>
                </form>
            </div>
        </div>
        
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0">Exportar Relatório Financeiro</h5>
                <div>
                    <a href="{{ url_for('admin.export_financial', format='excel') }}{{ '?' + request.query_string.decode() if request.query_string }}" 
                       class="btn btn-outline-success btn-sm me-2">
                        <i class="fas fa-file-excel me-1"></i>Excel
                    </a>
                    <a href="{{ url_for('admin.export_financial', format='pdf') }}{{ '?' + request.query_string.decode() if request.query_string }}" 
                       class="btn btn-outline-danger btn-sm">
                        <i class="fas fa-file-pdf me-1"></i>PDF
                    </a>
                </div>
            </div>
            <div class="card-body">
                <p class="text-muted">Relatório financeiro com transações, receitas de taxas, volume de negócios e análise por período.</p>
            </div>
        </div>
    </div>

    <!-- Aba Convites -->
    <div class="tab-pane fade" id="convites" role="tabpanel">
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="mb-0"><i class="fas fa-filter me-2"></i>Filtros - Relatório de Convites</h5>
            </div>
            <div class="card-body">
                <form method="GET" action="{{ url_for('admin.relatorios_convites') }}" class="row g-3">
                    <div class="col-md-3">
                        <label class="form-label">Data Inicial</label>
                        <input type="date" name="start_date" class="form-control" value="{{ request.args.get('start_date', '') }}">
                    </div>
                    <div class="col-md-3">
                        <label class="form-label">Data Final</label>
                        <input type="date" name="end_date" class="form-control" value="{{ request.args.get('end_date', '') }}">
                    </div>
                    <div class="col-md-3">
                        <label class="form-label">Status</label>
                        <select name="status" class="form-select">
                            <option value="todos">Todos os Status</option>
                            <option value="pendente" {{ 'selected' if request.args.get('status') == 'pendente' }}>Pendente</option>
                            <option value="aceito" {{ 'selected' if request.args.get('status') == 'aceito' }}>Aceito</option>
                            <option value="recusado" {{ 'selected' if request.args.get('status') == 'recusado' }}>Recusado</option>
                            <option value="expirado" {{ 'selected' if request.args.get('status') == 'expirado' }}>Expirado</option>
                            <option value="convertido" {{ 'selected' if request.args.get('status') == 'convertido' }}>Convertido</option>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <label class="form-label">&nbsp;</label>
                        <button type="submit" class="btn btn-primary w-100">
                            <i class="fas fa-search me-1"></i>Filtrar
                        </button>
                    </div>
                </form>
            </div>
        </div>
        
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0">Exportar Relatório de Convites</h5>
                <div>
                    <a href="{{ url_for('admin.export_invites', format='excel') }}{{ '?' + request.query_string.decode() if request.query_string }}" 
                       class="btn btn-outline-success btn-sm me-2">
                        <i class="fas fa-file-excel me-1"></i>Excel
                    </a>
                    <a href="{{ url_for('admin.export_invites', format='pdf') }}{{ '?' + request.query_string.decode() if request.query_string }}" 
                       class="btn btn-outline-danger btn-sm">
                        <i class="fas fa-file-pdf me-1"></i>PDF
                    </a>
                </div>
            </div>
            <div class="card-body">
                <p class="text-muted">Relatório de convites com taxas de aceitação, conversão e análise de performance do sistema de convites.</p>
            </div>
        </div>
    </div>
</div>

<div class="alert alert-info mt-4">
    <i class="fas fa-info-circle me-2"></i>
    <strong>Nota:</strong> Os relatórios são gerados em tempo real com base nos dados atuais do sistema. Use os filtros em cada aba para personalizar os dados exportados.
</div>
{% endblock %}

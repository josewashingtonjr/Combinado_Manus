{% extends "admin/base_admin.html" %}

{% block title %}Configuração de Taxas - Sistema Combinado{% endblock %}

{% block admin_content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h1><i class="fas fa-percentage me-2"></i>Configuração de Taxas</h1>
    <nav aria-label="breadcrumb">
        <ol class="breadcrumb">
            <li class="breadcrumb-item"><a href="{{ url_for('admin.dashboard') }}">Dashboard</a></li>
            <li class="breadcrumb-item"><a href="{{ url_for('admin.dashboard') }}">Financeiro</a></li>
            <li class="breadcrumb-item active">Taxas</li>
        </ol>
    </nav>
</div>

<!-- Informações Importantes -->
<div class="row mb-4">
    <div class="col-md-12">
        <div class="alert alert-info">
            <h5><i class="fas fa-info-circle me-2"></i>Informações Importantes</h5>
            <ul class="mb-0">
                <li><strong>Taxa do Sistema:</strong> Percentual cobrado sobre cada transação concluída (padrão: 5%)</li>
                <li><strong>Taxa de Saque:</strong> Valor fixo cobrado quando usuários fazem saques (padrão: R$ 2,50)</li>
                <li><strong>Taxa de Depósito:</strong> Valor fixo cobrado em depósitos (padrão: gratuito)</li>
                <li><strong>Valor Mínimo:</strong> Valor mínimo permitido para saques (padrão: R$ 10,00)</li>
            </ul>
        </div>
    </div>
</div>

<!-- Formulário de Configuração -->
<div class="row">
    <div class="col-md-8">
        <div class="card shadow-sm">
            <div class="card-header bg-warning text-white">
                <h5 class="mb-0"><i class="fas fa-cogs me-2"></i>Configurações de Taxas</h5>
            </div>
            <div class="card-body">
                <form method="POST" id="taxasForm">
                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="taxa_sistema" class="form-label">
                                <i class="fas fa-percentage me-1"></i>Taxa do Sistema (%)
                            </label>
                            <div class="input-group">
                                <input type="number" 
                                       class="form-control" 
                                       id="taxa_sistema" 
                                       name="taxa_sistema" 
                                       value="{{ configs.taxa_sistema }}" 
                                       min="0" 
                                       max="50" 
                                       step="0.1" 
                                       required>
                                <span class="input-group-text">%</span>
                            </div>
                            <div class="form-text">Percentual cobrado sobre transações concluídas</div>
                        </div>
                        
                        <div class="col-md-6 mb-3">
                            <label for="taxa_saque" class="form-label">
                                <i class="fas fa-money-bill-wave me-1"></i>Taxa de Saque
                            </label>
                            <div class="input-group">
                                <span class="input-group-text">R$</span>
                                <input type="number" 
                                       class="form-control" 
                                       id="taxa_saque" 
                                       name="taxa_saque" 
                                       value="{{ configs.taxa_saque }}" 
                                       min="0" 
                                       step="0.01" 
                                       required>
                            </div>
                            <div class="form-text">Valor fixo cobrado em saques</div>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="taxa_deposito" class="form-label">
                                <i class="fas fa-plus-circle me-1"></i>Taxa de Depósito
                            </label>
                            <div class="input-group">
                                <span class="input-group-text">R$</span>
                                <input type="number" 
                                       class="form-control" 
                                       id="taxa_deposito" 
                                       name="taxa_deposito" 
                                       value="{{ configs.taxa_deposito }}" 
                                       min="0" 
                                       step="0.01" 
                                       required>
                            </div>
                            <div class="form-text">Valor fixo cobrado em depósitos (0 = gratuito)</div>
                        </div>
                        
                        <div class="col-md-6 mb-3">
                            <label for="valor_minimo_saque" class="form-label">
                                <i class="fas fa-arrow-down me-1"></i>Valor Mínimo de Saque
                            </label>
                            <div class="input-group">
                                <span class="input-group-text">R$</span>
                                <input type="number" 
                                       class="form-control" 
                                       id="valor_minimo_saque" 
                                       name="valor_minimo_saque" 
                                       value="{{ configs.valor_minimo_saque }}" 
                                       min="1" 
                                       step="0.01" 
                                       required>
                            </div>
                            <div class="form-text">Valor mínimo permitido para saques</div>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-12">
                            <div class="d-grid gap-2 d-md-flex justify-content-md-end">
                                <a href="{{ url_for('admin.dashboard') }}" class="btn btn-secondary me-md-2">
                                    <i class="fas fa-arrow-left me-1"></i>Voltar
                                </a>
                                <button type="submit" class="btn btn-warning">
                                    <i class="fas fa-save me-1"></i>Salvar Configurações
                                </button>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>
    
    <!-- Simulador de Impacto -->
    <div class="col-md-4">
        <div class="card shadow-sm">
            <div class="card-header bg-info text-white">
                <h5 class="mb-0"><i class="fas fa-calculator me-2"></i>Simulador de Impacto</h5>
            </div>
            <div class="card-body">
                <div class="mb-3">
                    <label for="valor_simulacao" class="form-label">Valor da Transação (R$)</label>
                    <input type="number" class="form-control" id="valor_simulacao" value="100" min="1" step="0.01">
                </div>
                
                <div class="card bg-light">
                    <div class="card-body">
                        <h6>Simulação:</h6>
                        <div class="mb-2">
                            <strong>Valor da Transação:</strong>
                            <span class="float-end" id="sim_valor_transacao">R$ 100,00</span>
                        </div>
                        <div class="mb-2">
                            <strong>Taxa do Sistema:</strong>
                            <span class="float-end text-warning" id="sim_taxa_sistema">R$ 5,00</span>
                        </div>
                        <div class="mb-2">
                            <strong>Valor para Prestador:</strong>
                            <span class="float-end text-success" id="sim_valor_prestador">R$ 95,00</span>
                        </div>
                        <hr>
                        <div>
                            <strong>Taxa de Saque:</strong>
                            <span class="float-end text-info" id="sim_taxa_saque">R$ 2,50</span>
                        </div>
                    </div>
                </div>
                
                <div class="mt-3">
                    <small class="text-muted">
                        <i class="fas fa-info-circle me-1"></i>
                        Simulação atualizada automaticamente conforme você altera as taxas
                    </small>
                </div>
            </div>
        </div>
        
        <!-- Histórico de Alterações -->
        <div class="card shadow-sm mt-3">
            <div class="card-header bg-secondary text-white">
                <h6 class="mb-0"><i class="fas fa-history me-2"></i>Última Atualização</h6>
            </div>
            <div class="card-body">
                <p class="mb-1"><strong>Data:</strong> {{ moment().format('DD/MM/YYYY HH:mm') }}</p>
                <p class="mb-0"><strong>Admin:</strong> {{ session.admin_email }}</p>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// Simulador de impacto em tempo real
function atualizarSimulacao() {
    const valorTransacao = parseFloat(document.getElementById('valor_simulacao').value) || 0;
    const taxaSistema = parseFloat(document.getElementById('taxa_sistema').value) || 0;
    const taxaSaque = parseFloat(document.getElementById('taxa_saque').value) || 0;
    
    const valorTaxa = valorTransacao * (taxaSistema / 100);
    const valorPrestador = valorTransacao - valorTaxa;
    
    document.getElementById('sim_valor_transacao').textContent = 'R$ ' + valorTransacao.toFixed(2);
    document.getElementById('sim_taxa_sistema').textContent = 'R$ ' + valorTaxa.toFixed(2);
    document.getElementById('sim_valor_prestador').textContent = 'R$ ' + valorPrestador.toFixed(2);
    document.getElementById('sim_taxa_saque').textContent = 'R$ ' + taxaSaque.toFixed(2);
}

// Event listeners para atualização em tempo real
document.getElementById('valor_simulacao').addEventListener('input', atualizarSimulacao);
document.getElementById('taxa_sistema').addEventListener('input', atualizarSimulacao);
document.getElementById('taxa_saque').addEventListener('input', atualizarSimulacao);

// Atualizar simulação inicial
atualizarSimulacao();

// Validação do formulário
document.getElementById('taxasForm').addEventListener('submit', function(e) {
    const taxaSistema = parseFloat(document.getElementById('taxa_sistema').value);
    
    if (taxaSistema < 0 || taxaSistema > 50) {
        e.preventDefault();
        alert('A taxa do sistema deve estar entre 0% e 50%');
        return false;
    }
    
    if (confirm('Tem certeza que deseja alterar as configurações de taxas? Esta ação afetará todas as futuras transações.')) {
        return true;
    } else {
        e.preventDefault();
        return false;
    }
});
</script>
{% endblock %}
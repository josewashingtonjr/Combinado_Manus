{% extends "admin/base_admin.html" %}

{% block title %}Configuração de Taxas - Admin{% endblock %}

{% block admin_content %}
<div class="container-fluid">
    <div class="row mb-4">
        <div class="col-12">
            <h2><i class="fas fa-percentage me-2"></i>Configuração de Taxas do Sistema</h2>
            <p class="text-muted">Configure as taxas aplicadas nas ordens de serviço. As alterações afetarão apenas ordens criadas após a atualização.</p>
        </div>
    </div>

    {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
            {% for category, message in messages %}
                <div class="alert alert-{{ 'success' if category == 'success' else 'danger' }} alert-dismissible fade show" role="alert">
                    {{ message }}
                    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Fechar"></button>
                </div>
            {% endfor %}
        {% endif %}
    {% endwith %}

    <div class="row">
        <!-- Formulário de Configuração -->
        <div class="col-lg-8">
            <div class="card shadow-sm">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0"><i class="fas fa-cog me-2"></i>Taxas de Ordens</h5>
                </div>
                <div class="card-body">
                    <form method="POST" action="{{ url_for('admin.salvar_configuracoes_taxas') }}" id="formTaxas">
                        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                        
                        <!-- Taxa da Plataforma -->
                        <div class="mb-4">
                            <label for="platform_fee_percentage" class="form-label">
                                <strong><i class="fas fa-chart-line me-2 text-primary"></i>Taxa da Plataforma (%)</strong>
                            </label>
                            <div class="input-group">
                                <input 
                                    type="number" 
                                    class="form-control" 
                                    id="platform_fee_percentage" 
                                    name="platform_fee_percentage" 
                                    value="{{ fees.platform_fee_percentage if fees else '5.0' }}" 
                                    step="0.1" 
                                    min="0" 
                                    max="100" 
                                    required
                                    aria-describedby="helpPlatformFee">
                                <span class="input-group-text">%</span>
                            </div>
                            <div id="helpPlatformFee" class="form-text">
                                <i class="fas fa-info-circle me-1"></i>
                                Percentual cobrado sobre o valor do serviço. Esta taxa é deduzida do pagamento ao prestador.
                                <br>
                                <strong>Valor atual:</strong> {{ fees.platform_fee_percentage if fees else '5.0' }}%
                            </div>
                        </div>

                        <!-- Taxa de Contestação -->
                        <div class="mb-4">
                            <label for="contestation_fee" class="form-label">
                                <strong><i class="fas fa-shield-alt me-2 text-warning"></i>Taxa de Contestação (R$)</strong>
                            </label>
                            <div class="input-group">
                                <span class="input-group-text">R$</span>
                                <input 
                                    type="number" 
                                    class="form-control" 
                                    id="contestation_fee" 
                                    name="contestation_fee" 
                                    value="{{ fees.contestation_fee if fees else '10.00' }}" 
                                    step="0.01" 
                                    min="0.01" 
                                    required
                                    aria-describedby="helpContestationFee">
                            </div>
                            <div id="helpContestationFee" class="form-text">
                                <i class="fas fa-info-circle me-1"></i>
                                Valor fixo bloqueado como garantia de ambas as partes. É devolvido se não houver contestação ou se a parte vencer a disputa.
                                <br>
                                <strong>Valor atual:</strong> R$ {{ fees.contestation_fee if fees else '10.00' }}
                            </div>
                        </div>

                        <!-- Taxa de Cancelamento -->
                        <div class="mb-4">
                            <label for="cancellation_fee_percentage" class="form-label">
                                <strong><i class="fas fa-ban me-2 text-danger"></i>Taxa de Cancelamento (%)</strong>
                            </label>
                            <div class="input-group">
                                <input 
                                    type="number" 
                                    class="form-control" 
                                    id="cancellation_fee_percentage" 
                                    name="cancellation_fee_percentage" 
                                    value="{{ fees.cancellation_fee_percentage if fees else '10.0' }}" 
                                    step="0.1" 
                                    min="0" 
                                    max="100" 
                                    required
                                    aria-describedby="helpCancellationFee">
                                <span class="input-group-text">%</span>
                            </div>
                            <div id="helpCancellationFee" class="form-text">
                                <i class="fas fa-info-circle me-1"></i>
                                Percentual do valor do serviço cobrado como multa em caso de cancelamento. 50% vai para a plataforma e 50% para a parte prejudicada.
                                <br>
                                <strong>Valor atual:</strong> {{ fees.cancellation_fee_percentage if fees else '10.0' }}%
                            </div>
                        </div>

                        <hr class="my-4">

                        <!-- Botão de Salvar -->
                        <div class="d-grid gap-2">
                            <button type="button" class="btn btn-primary btn-lg" onclick="confirmarAlteracao()">
                                <i class="fas fa-save me-2"></i>Salvar Configurações
                            </button>
                            <a href="{{ url_for('admin.dashboard') }}" class="btn btn-outline-secondary">
                                <i class="fas fa-times me-2"></i>Cancelar
                            </a>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <!-- Painel de Informações -->
        <div class="col-lg-4">
            <!-- Avisos Importantes -->
            <div class="card shadow-sm mb-3">
                <div class="card-header bg-warning text-dark">
                    <h6 class="mb-0"><i class="fas fa-exclamation-triangle me-2"></i>Avisos Importantes</h6>
                </div>
                <div class="card-body">
                    <ul class="list-unstyled mb-0">
                        <li class="mb-2">
                            <i class="fas fa-check-circle text-success me-2"></i>
                            <small>As novas taxas serão aplicadas <strong>apenas para ordens criadas após a alteração</strong>.</small>
                        </li>
                        <li class="mb-2">
                            <i class="fas fa-check-circle text-success me-2"></i>
                            <small>Ordens existentes manterão as taxas vigentes no momento de sua criação.</small>
                        </li>
                        <li class="mb-2">
                            <i class="fas fa-check-circle text-success me-2"></i>
                            <small>Todas as alterações são registradas no log do sistema.</small>
                        </li>
                        <li class="mb-0">
                            <i class="fas fa-check-circle text-success me-2"></i>
                            <small>Os usuários verão as taxas atualizadas antes de criar novas ordens.</small>
                        </li>
                    </ul>
                </div>
            </div>

            <!-- Impacto das Taxas -->
            <div class="card shadow-sm mb-3">
                <div class="card-header bg-info text-white">
                    <h6 class="mb-0"><i class="fas fa-calculator me-2"></i>Simulação de Impacto</h6>
                </div>
                <div class="card-body">
                    <p class="small mb-2"><strong>Exemplo para um serviço de R$ 100,00:</strong></p>
                    
                    <div class="mb-3">
                        <div class="d-flex justify-content-between small">
                            <span>Valor do serviço:</span>
                            <span class="fw-bold">R$ 100,00</span>
                        </div>
                        <div class="d-flex justify-content-between small text-danger">
                            <span>Taxa da plataforma (<span id="simPlatformFee">{{ fees.platform_fee_percentage if fees else '5.0' }}</span>%):</span>
                            <span class="fw-bold">- R$ <span id="simPlatformValue">5.00</span></span>
                        </div>
                        <div class="d-flex justify-content-between small text-primary">
                            <span>Prestador recebe:</span>
                            <span class="fw-bold">R$ <span id="simProviderReceives">95.00</span></span>
                        </div>
                    </div>

                    <hr>

                    <div class="mb-3">
                        <p class="small mb-2"><strong>Bloqueios iniciais:</strong></p>
                        <div class="d-flex justify-content-between small">
                            <span>Cliente (serviço + garantia):</span>
                            <span class="fw-bold">R$ <span id="simClientBlocked">110.00</span></span>
                        </div>
                        <div class="d-flex justify-content-between small">
                            <span>Prestador (garantia):</span>
                            <span class="fw-bold">R$ <span id="simProviderBlocked">10.00</span></span>
                        </div>
                    </div>

                    <hr>

                    <div class="mb-0">
                        <p class="small mb-2"><strong>Em caso de cancelamento:</strong></p>
                        <div class="d-flex justify-content-between small text-danger">
                            <span>Multa (<span id="simCancellationFee">{{ fees.cancellation_fee_percentage if fees else '10.0' }}</span>%):</span>
                            <span class="fw-bold">R$ <span id="simCancellationValue">10.00</span></span>
                        </div>
                        <div class="d-flex justify-content-between small">
                            <span class="text-muted">→ Plataforma (50%):</span>
                            <span class="text-muted">R$ <span id="simCancellationPlatform">5.00</span></span>
                        </div>
                        <div class="d-flex justify-content-between small">
                            <span class="text-muted">→ Parte prejudicada (50%):</span>
                            <span class="text-muted">R$ <span id="simCancellationVictim">5.00</span></span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Histórico de Alterações -->
            <div class="card shadow-sm">
                <div class="card-header bg-secondary text-white">
                    <h6 class="mb-0"><i class="fas fa-history me-2"></i>Última Atualização</h6>
                </div>
                <div class="card-body">
                    <p class="small text-muted mb-0">
                        <i class="fas fa-clock me-1"></i>
                        As configurações podem ser alteradas a qualquer momento. Consulte os logs do sistema para ver o histórico completo de alterações.
                    </p>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal de Confirmação -->
<div class="modal fade" id="modalConfirmacao" tabindex="-1" aria-labelledby="modalConfirmacaoLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header bg-warning text-dark">
                <h5 class="modal-title" id="modalConfirmacaoLabel">
                    <i class="fas fa-exclamation-triangle me-2"></i>Confirmar Alteração de Taxas
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fechar"></button>
            </div>
            <div class="modal-body">
                <p><strong>Você está prestes a alterar as taxas do sistema.</strong></p>
                <p class="mb-2">Novos valores:</p>
                <ul>
                    <li><strong>Taxa da Plataforma:</strong> <span id="confirmPlatformFee"></span>%</li>
                    <li><strong>Taxa de Contestação:</strong> R$ <span id="confirmContestationFee"></span></li>
                    <li><strong>Taxa de Cancelamento:</strong> <span id="confirmCancellationFee"></span>%</li>
                </ul>
                <div class="alert alert-info mb-0">
                    <i class="fas fa-info-circle me-2"></i>
                    <small>Lembre-se: estas taxas serão aplicadas apenas para <strong>novas ordens</strong> criadas após esta alteração.</small>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="fas fa-times me-2"></i>Cancelar
                </button>
                <button type="button" class="btn btn-primary" onclick="submitForm()">
                    <i class="fas fa-check me-2"></i>Confirmar Alteração
                </button>
            </div>
        </div>
    </div>
</div>

<script>
// Validação client-side e simulação em tempo real
document.addEventListener('DOMContentLoaded', function() {
    const platformFeeInput = document.getElementById('platform_fee_percentage');
    const contestationFeeInput = document.getElementById('contestation_fee');
    const cancellationFeeInput = document.getElementById('cancellation_fee_percentage');
    
    // Atualizar simulação quando os valores mudarem
    platformFeeInput.addEventListener('input', updateSimulation);
    contestationFeeInput.addEventListener('input', updateSimulation);
    cancellationFeeInput.addEventListener('input', updateSimulation);
    
    // Validação em tempo real
    platformFeeInput.addEventListener('blur', function() {
        validatePercentage(this, 'Taxa da Plataforma');
    });
    
    contestationFeeInput.addEventListener('blur', function() {
        validatePositive(this, 'Taxa de Contestação');
    });
    
    cancellationFeeInput.addEventListener('blur', function() {
        validatePercentage(this, 'Taxa de Cancelamento');
    });
});

function updateSimulation() {
    const serviceValue = 100.00;
    const platformFee = parseFloat(document.getElementById('platform_fee_percentage').value) || 0;
    const contestationFee = parseFloat(document.getElementById('contestation_fee').value) || 0;
    const cancellationFee = parseFloat(document.getElementById('cancellation_fee_percentage').value) || 0;
    
    // Calcular valores
    const platformValue = (serviceValue * platformFee / 100).toFixed(2);
    const providerReceives = (serviceValue - platformValue).toFixed(2);
    const clientBlocked = (serviceValue + contestationFee).toFixed(2);
    const providerBlocked = contestationFee.toFixed(2);
    const cancellationValue = (serviceValue * cancellationFee / 100).toFixed(2);
    const cancellationPlatform = (cancellationValue / 2).toFixed(2);
    const cancellationVictim = (cancellationValue / 2).toFixed(2);
    
    // Atualizar interface
    document.getElementById('simPlatformFee').textContent = platformFee.toFixed(1);
    document.getElementById('simPlatformValue').textContent = platformValue;
    document.getElementById('simProviderReceives').textContent = providerReceives;
    document.getElementById('simClientBlocked').textContent = clientBlocked;
    document.getElementById('simProviderBlocked').textContent = providerBlocked;
    document.getElementById('simCancellationFee').textContent = cancellationFee.toFixed(1);
    document.getElementById('simCancellationValue').textContent = cancellationValue;
    document.getElementById('simCancellationPlatform').textContent = cancellationPlatform;
    document.getElementById('simCancellationVictim').textContent = cancellationVictim;
}

function validatePercentage(input, fieldName) {
    const value = parseFloat(input.value);
    if (isNaN(value) || value < 0 || value > 100) {
        alert(fieldName + ' deve estar entre 0% e 100%.');
        input.focus();
        return false;
    }
    return true;
}

function validatePositive(input, fieldName) {
    const value = parseFloat(input.value);
    if (isNaN(value) || value <= 0) {
        alert(fieldName + ' deve ser um valor positivo.');
        input.focus();
        return false;
    }
    return true;
}

function confirmarAlteracao() {
    // Validar todos os campos
    const platformFeeInput = document.getElementById('platform_fee_percentage');
    const contestationFeeInput = document.getElementById('contestation_fee');
    const cancellationFeeInput = document.getElementById('cancellation_fee_percentage');
    
    if (!validatePercentage(platformFeeInput, 'Taxa da Plataforma')) return;
    if (!validatePositive(contestationFeeInput, 'Taxa de Contestação')) return;
    if (!validatePercentage(cancellationFeeInput, 'Taxa de Cancelamento')) return;
    
    // Preencher valores no modal de confirmação
    document.getElementById('confirmPlatformFee').textContent = platformFeeInput.value;
    document.getElementById('confirmContestationFee').textContent = contestationFeeInput.value;
    document.getElementById('confirmCancellationFee').textContent = cancellationFeeInput.value;
    
    // Mostrar modal
    const modal = new bootstrap.Modal(document.getElementById('modalConfirmacao'));
    modal.show();
}

function submitForm() {
    // Fechar modal
    const modal = bootstrap.Modal.getInstance(document.getElementById('modalConfirmacao'));
    modal.hide();
    
    // Submeter formulário
    document.getElementById('formTaxas').submit();
}
</script>

<style>
/* Estilos adicionais para melhorar a aparência */
.form-text {
    font-size: 0.875rem;
    line-height: 1.4;
}

.card {
    border: none;
    border-radius: 0.5rem;
}

.card-header {
    border-radius: 0.5rem 0.5rem 0 0 !important;
    font-weight: 500;
}

.input-group-text {
    background-color: #f8f9fa;
    border-color: #dee2e6;
}

.form-control:focus {
    border-color: #0d6efd;
    box-shadow: 0 0 0 0.25rem rgba(13, 110, 253, 0.25);
}

.btn-lg {
    padding: 0.75rem 1.5rem;
    font-size: 1.1rem;
}

.list-unstyled li {
    padding: 0.25rem 0;
}

.modal-content {
    border: none;
    border-radius: 0.5rem;
}

.alert {
    border-radius: 0.375rem;
}

/* Animação suave para mudanças nos valores da simulação */
#simPlatformValue, #simProviderReceives, #simClientBlocked, 
#simProviderBlocked, #simCancellationValue, #simCancellationPlatform, 
#simCancellationVictim {
    transition: all 0.3s ease;
}
</style>
{% endblock %}
